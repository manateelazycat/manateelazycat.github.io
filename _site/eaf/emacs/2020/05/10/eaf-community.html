<!DOCTYPE html>

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
<title>欢迎加入EAF</title>


        <link rel="stylesheet" href="http://localhost:4000/styles/font.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="http://localhost:4000/styles/post.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="http://localhost:4000/styles/post_mobile.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="http://localhost:4000/styles/navigatebar.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="http://localhost:4000/styles/navigatebar_mobile.css">
        <link rel="stylesheet" href="http://localhost:4000/theme/highlight.css">
    </head>
    <body>
        <div class="navigatebar">
    <div class="navigatebar-button navigatebar-mine">
        <a href="http://localhost:4000/index.html">ManateeLazyCat</a>
    </div>
    <div class="navigatebar-button">
        <a href="http://localhost:4000/index.html">Home</a>
    </div>
    <div class="navigatebar-button">
        <a href="http://localhost:4000/tags.html">Tags</a>
    </div>
    <div class="navigatebar-button">
        <a href="http://localhost:4000/projects.html">Projects</a>
    </div>
    <div class="navigatebar-button">
        <a href="http://localhost:4000/feed.xml">Feeds</a>
    </div>
    <div class="navigatebar-button navigatebar-about">
        <a href="http://localhost:4000/about.html">About</a>
    </div>
</div>

        <div class="content-area">
            <div class="title">
                欢迎加入EAF
            </div>
            <div class="category-area">
                「
                <a href="http://localhost:4000/tags.html#EAF">
                    <div class="category">
                        EAF
                    </div>
                </a>
                
                <a href="http://localhost:4000/tags.html#Emacs">
                    <div class="category">
                        Emacs
                    </div>
                </a>
                」
            </div>
            <div class="char-counter">
                字数9950 2020-05-10
            </div>
            <div class="content">
                <h3 id="欢迎加入eaf">欢迎加入EAF</h3>
<p><a href="https://isrc.iscas.ac.cn/summer2020/#/">2020 中国开源之夏</a>的同学们，欢迎加入Emacs开源社区并参与EAF项目！</p>

<p>EAF在本次中国开源之夏活动中属于中～高难度的开源社区项目，你需要快速学会Elisp、Python、Qt甚至是JavaScript才能挑战EAF中的任务。</p>

<p>为了帮助同学们快速入门EAF开发，我们已经为同学们准备了详细的技术文档和导师指导，即使是这样，在短短的暑期时间内，EAF依然是顶级黑客才能涉足的领域，请同学们量力而行！</p>

<p>如果你本身就是Emacs黑客，并熟悉Qt或JavaScript图形开发，最高的项目奖金(项目奖金12000)基本上是手到擒来。</p>

<p>EAF属于自由软件，以GPL3许可证发布，当你贡献EAF代码时也就必须赞同自由软件精神和受GPL3许可证约束。</p>

<h3 id="什么是eaf">什么是EAF?</h3>
<p>EAF是Emacs Application Framework的缩写，EAF是新一代的Emacs应用框架，通过EAF框架，你可以使用Qt来任意扩展Emacs的多媒体能力。</p>

<p>目前EAF已经开发了如下应用：</p>
<ol>
  <li>全键盘操作的黑客浏览器</li>
  <li>Markdown和Org-Mode实时预览器</li>
  <li>图片浏览器</li>
  <li>基于plyr.js的全功能视频播放器</li>
  <li>Emacs中性能最好的PDF阅读器</li>
  <li>摄像头应用</li>
  <li>移动设备文件共享插件</li>
  <li>基于Xterm.js的终端模拟器，你可以在里面运行VI，哈哈哈哈</li>
  <li>RSS&amp;Atom新闻阅读器</li>
  <li>Aria2图形下载客户端</li>
  <li>全键盘操作的思维导图软件, 支持Org-Mode和Markdown文件导出</li>
  <li>基于文本语法的复杂流程图实时生成工具</li>
  <li>基于浏览器和Org-Mode的笔记管理应用</li>
</ol>

<p>通过EAF框架，顶级黑客可以全键盘做所有事情，你不再需要平铺式窗口管理器和外部应用就可以用统一的键盘快捷键来操作所有应用。</p>

<h3 id="eaf愿景">EAF愿景</h3>
<p>Emacs距今已经有45年的发展历史，在这45年内，全世界最顶级的黑客在贡献自己的智慧和想象力，一起构建了Emacs这个伟大的开发者工具生态。
当你是一个会十几门编程语言的黑客和键盘流信仰者，Emacs绝对是你的不二之选。</p>

<p>Emacs的劣势也是因为它太古老了，导致在多线程和图形扩展能力已经无法跟上时代的步伐，在很多地方发展落后于IDEA和VSCode。</p>

<p>EAF的愿景是在保留Emacs古老的黑客文化和庞大的开发者插件生态前提下，通过EAF框架扩展Emacs的多线程和图形渲染能力，实现Live In Emacs的理想。</p>

<h3 id="eaf架构设计">EAF架构设计</h3>
<p><img src="http://localhost:4000/pics/eaf-community/framework.png" alt="EAF 架构图" /></p>

<p>用最通俗的话来讲, EAF其实做的工作和手机贴膜差不多, 就是先把 PyQt5 的图形程序运行起来, 然后通过QWindow::setParent 的技术把PyQt5的窗口粘贴到Emacs窗口对应的位置。</p>

<p>EAF整体架构的关键技术有以下几点:</p>

<ol>
  <li>通过 QtGraphicsView/QtGraphicsSence 来实现实时图形混合, 多个窗口可以共用一个进程的绘制内容, 这样就可以适应 Emacs 的 Window/Buffer 窗口模型设计, 从而最终让 PyQt5 窗口可以像 Emacs Buffer 那样集成和管理</li>
  <li>通过QWindow::setParent技术, 粘贴 PyQt5 的窗口到 Emacs EAF Buffer 的坐标上, 实现多个进程的窗口看起来是一个程序里面的不同部分, 不清楚QWindow::setParent技术的同学, 可以想象一下 Google Chrome 的多进程架构设计. QWindow::setParent的技术除了达到跨进程粘贴的作用外, 还变相的实现了多进程沙箱的设计, EAF图形化的程序运行在单独的进程中, 即使出现了意外崩溃的情况, 也不会影响Emacs本身的稳定性</li>
  <li>在Emacs端实现了一个事件监听循环, 当用户在 EAF Buffer按下任何按键, 都会通过 DBus 发送事件消息给 Python 进程, Python 进程再伪造相应的事件来模拟Emacs端用户的键盘输入</li>
</ol>

<p>通过EAF架构可以实现Elisp、Python和JavaScript这三种语言相互混合调用，EAF黑客可以通过Python和JavaScript无限扩展Emacs的能力。</p>

<h3 id="eaf安装">EAF安装</h3>
<p>因为EAF开发者本身都在用Arch Linux, 所以Arch Linux是最容易安装EAF的开发环境。</p>

<p>请按照下面方式安装EAF：</p>

<h4 id="1-安装eaf依赖">1. 安装EAF依赖</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>pacman <span class="nt">-S</span> python-pyqt5 python-pyqt5-sip python-pyqtwebengine python-qrcode python-feedparser python-dbus python-pyinotify python-markdown nodejs aria2 libreoffice filebrowser
yay <span class="nt">-S</span> python-pymupdf python-grip
</code></pre></div></div>

<h4 id="2-下载eaf代码">2. 下载EAF代码</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/manateelazycat/emacs-application-framework.git
</code></pre></div></div>

<p>拷贝代码到 ~/.emacs.d 目录下</p>

<h4 id="3-加载eaf">3. 加载EAF</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>defun add-subdirs-to-load-path <span class="o">(</span><span class="nb">dir</span><span class="o">)</span>
  <span class="s2">"Recursive add directories to </span><span class="sb">`</span>load-path<span class="s1">'."
  (let ((default-directory (file-name-as-directory dir)))
    (add-to-list '</span>load-path <span class="nb">dir</span><span class="o">)</span>
    <span class="o">(</span>normal-top-level-add-subdirs-to-load-path<span class="o">)))</span>
<span class="o">(</span>add-subdirs-to-load-path <span class="s2">"~/.emacs.d/"</span><span class="o">)</span>

<span class="o">(</span>require <span class="s1">'eaf)
</span></code></pre></div></div>

<p>把上面配置写入 ~/.emacs 文件中，重启Emacs即可</p>

<h3 id="体验eaf">体验EAF</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">应用名称</th>
      <th style="text-align: left">启动命令</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">浏览器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-browser</code> 在浏览器中打开或搜索</td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-browser-with-history</code> 搜索历史或者打开URL</td>
    </tr>
    <tr>
      <td style="text-align: left">HTML邮件渲染</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-mail-as-html</code> 在 <code class="language-plaintext highlighter-rouge">gnus</code>，<code class="language-plaintext highlighter-rouge">mu4e</code>，<code class="language-plaintext highlighter-rouge">notmuch</code> 等邮件客户端中执行</td>
    </tr>
    <tr>
      <td style="text-align: left">PDF阅读器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入PDF文件</td>
    </tr>
    <tr>
      <td style="text-align: left">视频播放器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入视频文件</td>
    </tr>
    <tr>
      <td style="text-align: left">图片浏览器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入图片文件</td>
    </tr>
    <tr>
      <td style="text-align: left">Markdown预览</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入Markdown文件</td>
    </tr>
    <tr>
      <td style="text-align: left">Org预览</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入Org文件</td>
    </tr>
    <tr>
      <td style="text-align: left">摄像头程序</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-camera</code></td>
    </tr>
    <tr>
      <td style="text-align: left">终端模拟器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-terminal</code></td>
    </tr>
    <tr>
      <td style="text-align: left">二维码下载文件</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-file-sender-qrcode</code> or <code class="language-plaintext highlighter-rouge">eaf-file-sender-qrcode-in-dired</code></td>
    </tr>
    <tr>
      <td style="text-align: left">二维码在线浏览器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-file-browser-qrcode</code></td>
    </tr>
    <tr>
      <td style="text-align: left">无线分享</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-airshare</code> 输入要分享给手机的字符串</td>
    </tr>
    <tr>
      <td style="text-align: left">RSS新闻阅读器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-rss-reader</code></td>
    </tr>
    <tr>
      <td style="text-align: left">思维导图</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-create-mindmap</code> or <code class="language-plaintext highlighter-rouge">M-x eaf-open-mindmap</code></td>
    </tr>
    <tr>
      <td style="text-align: left">办公文档阅读器</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-office</code></td>
    </tr>
    <tr>
      <td style="text-align: left">流程图</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open</code> 输入 mmd 格式文件</td>
    </tr>
    <tr>
      <td style="text-align: left">演示程序</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">M-x eaf-open-demo</code></td>
    </tr>
  </tbody>
</table>

<h3 id="eaf应用开发手册">EAF应用开发手册</h3>

<h4 id="eaf目录结构说明">EAF目录结构说明</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: left">目录</th>
      <th style="text-align: left">目录说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">app</td>
      <td style="text-align: left">EAF应用目录，每个应用都保持 app/app_name/buffer.py 的目录结构，每个应用的入口文件都是 buffer.py</td>
    </tr>
    <tr>
      <td style="text-align: left">core</td>
      <td style="text-align: left">EAF的核心模块</td>
    </tr>
    <tr>
      <td style="text-align: left">core/buffer.py</td>
      <td style="text-align: left">EAF应用的抽象接口文件，包括应用的IPC调用、事件转发和消息处理都通过这个接口文件来定义，如果你要扩展EAF核心功能，请仔细研究这个文件</td>
    </tr>
    <tr>
      <td style="text-align: left">core/view.py</td>
      <td style="text-align: left">EAF应用的显示接口文件，包括应用的跨进程粘贴、显示和缩放都通过这个接口文件来定义，在大多数情况下，EAF黑客都可以不用研究这个文件</td>
    </tr>
    <tr>
      <td style="text-align: left">core/browser.py</td>
      <td style="text-align: left">EAF的浏览器模块，所有浏览器的核心代码都在这个文件中，方便你通过浏览器模块结合JavaScript库快速开发应用，Python和JavaScript相互调用的方法可以重点研究这个文件</td>
    </tr>
    <tr>
      <td style="text-align: left">core/utils.py</td>
      <td style="text-align: left">一些常用的工具库，比如创建文件、获取新端口等，和应用无关的工具库代码可以放到这里，用于减少基础函数的重复代码</td>
    </tr>
    <tr>
      <td style="text-align: left">core/pyaria2.py</td>
      <td style="text-align: left">aria2 库文件，主要作用是让浏览器可以直接调用这个库发送RPC下载命令给 aria2 daemon</td>
    </tr>
    <tr>
      <td style="text-align: left">docker</td>
      <td style="text-align: left">Dockerfile, 主要用于构建EAF的Docker镜像，除非你用Docker来运行EAF，请直接忽视这个文件</td>
    </tr>
    <tr>
      <td style="text-align: left">screenshot</td>
      <td style="text-align: left">EAF各个应用截图效果</td>
    </tr>
    <tr>
      <td style="text-align: left">eaf.el</td>
      <td style="text-align: left">EAF Elisp进程部分，主要定义EAF应用的快捷键、监听Emacs窗口变化和事件，并通过DBus IPC发送消息给EAF的Python进程</td>
    </tr>
    <tr>
      <td style="text-align: left">eaf.py</td>
      <td style="text-align: left">EAF Python进程部分，用于启动EAF进程和接收Emacs消息，如果你要增加Emacs和EAF之间的IPC通讯接口，需要重点研究这个文件</td>
    </tr>
    <tr>
      <td style="text-align: left">LICENSE</td>
      <td style="text-align: left">GPLv3许可证文件</td>
    </tr>
    <tr>
      <td style="text-align: left">README.md</td>
      <td style="text-align: left">英文README</td>
    </tr>
    <tr>
      <td style="text-align: left">README.zh-CN.md</td>
      <td style="text-align: left">中文README</td>
    </tr>
    <tr>
      <td style="text-align: left">setup.py</td>
      <td style="text-align: left">python项目设置和工程文件，只是方便识别工程位置，没什么用，请直接忽视它</td>
    </tr>
  </tbody>
</table>

<h4 id="eaf应用开发入门">EAF应用开发入门</h4>
<p>在EAF项目中有一个最简单的示例应用 app/demo/buffer.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QColor</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QPushButton</span>
<span class="kn">from</span> <span class="nn">core.buffer</span> <span class="kn">import</span> <span class="n">Buffer</span>

<span class="k">class</span> <span class="nc">AppBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">emacs_var_dict</span><span class="p">,</span> <span class="n">module_path</span><span class="p">):</span>
        <span class="n">Buffer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">emacs_var_dict</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">"Hello, EAF hacker, it's working!!!"</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s">"font-size: 100px"</span><span class="p">)</span>
</code></pre></div></div>

<p>你可以通过 <code class="language-plaintext highlighter-rouge">eaf-open-demo</code> 命令来打开这个示例应用，示例应用是在Emacs中打开一个Qt窗口，Qt窗口只有一个可以点击的按钮，简单吧？</p>

<p>当你开发一个新的EAF应用时，你只需要下面的操作即可完成:</p>

<ol>
  <li>在app目录下新建一个应用的子目录，拷贝 app/demo/buffer.py 到应用子目录下面；</li>
  <li>新建一个Qt控件类，然后通过 <code class="language-plaintext highlighter-rouge">self.add_widget</code> 接口替换上面的对应代码，用来添加新的控件</li>
  <li>基于 <code class="language-plaintext highlighter-rouge">eaf-open</code> 接口创建一个打开EAF应用的Elisp函数，具体可以参考 eaf.el 文件中的 <code class="language-plaintext highlighter-rouge">eaf-open-demo</code> 代码实现</li>
</ol>

<h4 id="eaf应用开发接口说明">EAF应用开发接口说明</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QColor</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QPushButton</span>
<span class="kn">from</span> <span class="nn">core.buffer</span> <span class="kn">import</span> <span class="n">Buffer</span>

<span class="k">class</span> <span class="nc">AppBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">emacs_var_dict</span><span class="p">,</span> <span class="n">module_path</span><span class="p">):</span>
        <span class="n">Buffer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">emacs_var_dict</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">(</span><span class="s">"Hello, EAF hacker, it's working!!!"</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s">"font-size: 100px"</span><span class="p">)</span>
</code></pre></div></div>

<p>AppBuffer就是开发EAF应用所需要的入口类，它继承于Buffer类，Buffer类定义于 core/buffer.py 中。</p>

<ul>
  <li>buffer_id: 是Emacs传递过来的唯一ID，用于辨别每个EAF应用对象</li>
  <li>url: EAF应用的路径，可以是网页地址，也可以是PDF文件路径等，具体的形式取决于EAF应用的用途</li>
  <li>config_dir: EAF配置保存的目录, 用于存储EAF应用数据，比如Cookie、PDF阅读位置等</li>
  <li>arguments: EAF应用除了url外，从Emacs端传递的额外自定义数据, 比如app/browser应用，可以传递 temp_html_file 参数表示渲染HTML邮件后删除临时HTML文件</li>
  <li>emacs_var_dict: Emacs端的配置字典，比如Emacs端设置的代理配置等选项可以通过这个字典来实时获取</li>
  <li>module_path: 应用的模块路径，比如 app.browser.buffer app.pdf-viewer.buffer 用于区分当前运行的应用, 在基于浏览器开发的EAF应用中比较有用</li>
</ul>

<h5 id="在python端反馈消息给用户">在Python端反馈消息给用户</h5>
<p>如果你想发送消息给Emacs，告诉用户状态，可以在 AppBuffer 类下调用下面的接口即可发送消息给Emacs:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">self.message_to_emacs.emit</span><span class="p">(</span><span class="s">"hello from eaf"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在python端设置emacs变量">在Python端设置Emacs变量</h5>
<p>你可以通过下面的接口，直接在Python进程中设置Emacs的任意变量:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">self.set_emacs_var.emit</span><span class="p">(</span><span class="s">"var-name"</span><span class="o">,</span> <span class="s">"var-value"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在python端执行emacs代码">在Python端执行Emacs代码</h5>
<p>如果你想在Python端执行Elisp代码，可以用下面的方式来实现, 需要注意字符串写法，用Python的 ‘’’ 来包裹，避免Elisp代码中有字符串符号:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">self.eval_in_emacs.emit</span><span class="p">(</span><span class="o">'''</span><span class="p">(</span><span class="nv">message</span> <span class="s">"hello"</span><span class="p">)</span><span class="o">'''</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在elisp端调用python方法">在Elisp端调用Python方法</h5>
<p>在Emacs调用Python方法，稍微复杂点，你需要在AppBuffer定义方法，比如:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"Python Result"</span>
</code></pre></div></div>

<p>然后通过 <code class="language-plaintext highlighter-rouge">call_function</code> 接口来实现对Python方法的调用:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="nv">temp-var</span> <span class="p">(</span><span class="nv">eaf-call</span> <span class="s">"call_function"</span> <span class="nv">eaf--buffer-id</span> <span class="s">"get_foo"</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">eaf--buffer-id</code> 是EAF Buffer的局部变量，你按照上面的格式写代码，EAF框架会自动找到EAF应用对应的 <code class="language-plaintext highlighter-rouge">get_foo</code> 方法，并返回Python函数执行结果到Emacs进程。</p>

<h5 id="在elisp端调用python方法附带参数">在Elisp端调用Python方法，附带参数</h5>

<p>如果需要在调用Python函数时传递参数，可以用 <code class="language-plaintext highlighter-rouge">call_function_with_args</code> 接口来替代:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">eaf-call</span> <span class="s">"call_function_with_args"</span> <span class="nv">eaf--buffer-id</span> <span class="s">"function_name"</span> <span class="s">"function_args"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在python端读取用户的输入">在Python端读取用户的输入</h5>
<p>从Python端读取Emacs的输入，可以先看下面的示例代码:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>

<span class="k">class</span> <span class="nc">AppBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">Buffer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">PdfViewerWidget</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">send_jump_page_message</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_jump_page_message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_jump_page_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_input_message</span><span class="p">(</span><span class="s">"Jump to: "</span><span class="p">,</span> <span class="s">"jump_page"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_input_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_type</span><span class="p">,</span> <span class="n">result_content</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="s">"jump_page"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">jump_to_page</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result_content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cacel_input_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="s">"jump_page"</span><span class="p">:</span>
            <span class="o">...</span>

<span class="o">...</span>
</code></pre></div></div>

<ol>
  <li>首先在Python端，调用 <code class="language-plaintext highlighter-rouge">self.send_input_message</code> 接口发送用户输入提示字符和消息ID(<code class="language-plaintext highlighter-rouge">jump_page</code>)给Emacs</li>
  <li>用户通过Emacs Minibuffer输入数据后，会通过 <code class="language-plaintext highlighter-rouge">handle_input_message</code> 接口返回输入结果给Python回调函数</li>
  <li>如果用户取消了输入，你依然可以通过 <code class="language-plaintext highlighter-rouge">cancel_input_message</code> 接口，并根据输入消息类型做一些清理工作</li>
</ol>

<h5 id="在python端调用javascript函数">在Python端调用JavaScript函数</h5>
<p>如果你的EAF应用基于浏览器和JavaScript库来开发，建议你先看一下 app/mindmap/buffer.py 的代码，你可以通过 <code class="language-plaintext highlighter-rouge">eval_js</code> 接口来实现Python直接调用浏览器中的JavaScript代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">eval_js</span><span class="p">(</span><span class="s">"js_function(js_argument)"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在python端读取javascript函数的返回结果">在Python端读取JavaScript函数的返回结果</h5>
<p>获取JavaScript函数返回的结果和 <code class="language-plaintext highlighter-rouge">eval_js</code> 接口类似，只不过接口换成 <code class="language-plaintext highlighter-rouge">execute_js</code> 的形式，下面是从浏览器中获取选中文本的示例:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">execute_js</span><span class="p">(</span><span class="s">"get_selection();"</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="在python端改变标题">在Python端改变标题</h5>
<p>改变当前EAF的标题很简单，直接调用接口 <code class="language-plaintext highlighter-rouge">self.change_title("new_title")</code> 即可。</p>

<h5 id="保存和恢复应用数据">保存和恢复应用数据</h5>

<p>保存数据直接调用 <code class="language-plaintext highlighter-rouge">save_session_data</code> 接口，恢复数据接口用 <code class="language-plaintext highlighter-rouge">result_session_data</code>，下面是视频播放器保存和恢复视频观看位置的示例代码，存储方式就是任意字符串, 你可以根据字符串保存任意结构的数据，比如Json数据。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save_session_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">media_player</span><span class="o">.</span><span class="n">position</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">restore_session_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_data</span><span class="p">):</span>
    <span class="n">position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">session_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">media_player</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="全屏接口">全屏接口</h5>
<p>一些应用，比如浏览器点击视频播放器全屏按钮需要切换到全屏的状态，直接调用下面三个接口即可实现全屏的控制：</p>

<ul>
  <li>toggle_fullscreen: 切换全屏</li>
  <li>enable_fullscreen: 开启全屏</li>
  <li>disable_fullscreen: 退出全屏</li>
</ul>

<h5 id="在elisp端发送按键事件给python进程">在Elisp端发送按键事件给Python进程</h5>
<p>有时候，我们需要直接从Emacs端发送按键给EAF Python进程，比如我想在浏览器中按 Win + m 实现回车的操作，可以先定义一个Elisp函数：</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defun</span> <span class="nv">eaf-send-return-key</span> <span class="p">()</span>
  <span class="s">"Directly send return key to EAF Python side."</span>
  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">eaf-call</span> <span class="s">"send_key"</span> <span class="nv">eaf--buffer-id</span> <span class="s">"RET"</span><span class="p">))</span>
</code></pre></div></div>

<p>然后在Emacs中通过定义 eaf-*-keybinding 变量来实现 Win + m 快捷键发送回车事件, 具体代码可以查看 eaf.el 文件。</p>

<h5 id="在elisp段增加eaf应用配置项">在Elisp段增加EAF应用配置项</h5>
<p>如果你需要增加一些自定义选项以配置你的EAF应用，可以直接在 <code class="language-plaintext highlighter-rouge">eaf-var-list</code> 变量中增加新的自定义字段，<code class="language-plaintext highlighter-rouge">eaf-var-list</code> 定义在 eaf.el 文件中。</p>

<h5 id="eaf应用退出清理接口">EAF应用退出清理接口</h5>
<p>如果你的EAF应用有后台进程，你可以通过 <code class="language-plaintext highlighter-rouge">destroy_buffer</code> 接口在EAF应用 Buffer 被关闭之前做一些清理工作，下面是终端浏览器在推出之前杀掉 NodeJs 后台进程的示例代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">destroy_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">background_process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># NOTE: We need delete QWebEnginePage manual, otherwise QtWebEngineProcess won't quit.
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">web_page</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_widget</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="eaf调试技巧">EAF调试技巧</h4>

<p>下面分享有一些调试方法，方便你快速开发EAF应用：</p>

<h5 id="查看python打印代码的结果">查看Python打印代码的结果</h5>
<p>如果你在EAF Python端添加了 print 代码，你可以在Emacs中切换到 <code class="language-plaintext highlighter-rouge">*eaf*</code> buffer来观察运行时的print语句输出的结果。</p>

<h5 id="不用重启测试eaf应用代码">不用重启测试EAF应用代码</h5>
<p>第一次调用EAF应用后，EAF会在后台启动一个Python进程，如果你更新了EAF Python代码，请先调用 <code class="language-plaintext highlighter-rouge">eaf-stop-process</code> 命令，这个命令会杀掉老版本的Python后台进程，然后你再重新调用EAF函数即可测试新版EAF Python代码。</p>

<p>这个方法你掌握后，你不需要每次更新Python代码都要重启Emacs，极大提高了EAF的开发效率。</p>

<h5 id="调试段错误代码">调试段错误代码</h5>

<p>如果你在开发中遇到了段错误，可以按照下面的方式调试段错误：</p>

<ol>
  <li>先在Emacs ielm中执行 <code class="language-plaintext highlighter-rouge">(setq eaf-enable-debug t)</code> 命令打开段错误调试选项</li>
  <li>然后调用 <code class="language-plaintext highlighter-rouge">eaf-stop-process</code> 命令杀掉EAF Python老版后台进程</li>
  <li>继续调试，当发生段错误时， EAF会自动在 <code class="language-plaintext highlighter-rouge">*eaf*</code> Buffer中打印段错误的堆栈信息</li>
</ol>

<h4 id="eaf学习资料">EAF学习资料</h4>

<p>EAF是一个多语言的高难度项目，你需要同时具备Elisp、Python、Qt甚至JavaScript开发技能才能任意Hacking EAF，下面是一些我收集的学习资料帮助你快速学习入门：</p>

<ul>
  <li>Elisp材料：http://ergoemacs.org/emacs/elisp.html</li>
  <li>Python材料：《Python核心编程》这本书足够你精通Python语言</li>
  <li>PyQt5材料：http://zetcode.com/gui/pyqt5/ 这是我找到最简单的Qt入门教程</li>
  <li>JavaScript材料: Google和Github是你学习JavaScript最好的导师</li>
  <li>EAF: 建议先用熟练EAF后，直接阅读源代码来学习，最好的方法就是看app目录下的现有应用源码依葫芦画瓢 ;)</li>
</ul>

<h3 id="任务描述">任务描述</h3>

<p>为EAF乃至Emacs贡献的有趣之处便是，Emacs作为程序员的工具与工作环境，任何改进都可以被改进者直观的感受到享用到，从而激发自身的满足感与成就感并产生良性循环。EAF作为一个涵盖多个应用的框架，更是有许多大大小小可以改进的地方。开源社区不像学校老师布置作业学生完成作业那般死板，学生通过使用EAF探索它的能力并研究它的缺点，然后翻阅<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>寻找自己有兴趣下手的项目。学生甚至可以与导师沟通过的前提下往<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>添加上面不存在但有意义的项目并就此开展工作。有些只需要很基础的技术背景并增改几行代码便可完成，而有些需要多种语言概念的相互运用并开发出API。这些难度不同的项目全部列在<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>上面，只要学生愿意，则随时可以挑战。这便是开源社区的自由与魅力。</p>
<ul>
  <li>项目难度：中～高（根据完成<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>的质量与数量判定）</li>
  <li>项目产出要求：
完成指通过GitHub Review并merge入master的代码贡献。
    <ul>
      <li>中：
        <ol>
          <li>完成所有需要基础技术概念的小项目（<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>标注难度为<strong>低</strong>）。</li>
          <li>完成7个需要较为复杂的技术概念的小项目（<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>标注难度为<strong>中</strong>）。</li>
        </ol>
      </li>
      <li>高（进阶）：
        <ol>
          <li>在完成中级难度的基础上完成1个<a href="https://github.com/manateelazycat/emacs-application-framework/wiki/Todo-List">Todo-List</a>标注难度为<strong>高</strong>的小项目。</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>项目技术要求：
    <ul>
      <li>日常使用Linux和GNU Emacs</li>
      <li>熟悉 Emacs Lisp 或熟练使用任意Lisp方言</li>
      <li>熟练使用Python与PyQt5以及JavaScript</li>
      <li>熟悉DBus API</li>
      <li>合格的书面英语沟通能力</li>
    </ul>
  </li>
</ul>

<p>关于EAF开发任务的详细需求和更多核心技术细节，可以随时请教EAF导师<a href="https://github.com/MatthewZMD">曾明德/Matthew</a>, 也可以把问题发送到<a href="https://github.com/manateelazycat/emacs-application-framework/issues">Issue页面</a>, EAF大神会尽快回复你。</p>

<p>祝各位同学暑假快乐，Happy Hacking! ;)</p>

            </div>
        </div>
    </body>
</html>
