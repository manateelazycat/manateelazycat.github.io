<!DOCTYPE html>

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
<title>EAF的多线程编程模型</title>


        <link rel="stylesheet" href="//manateelazycat.github.io/styles/font.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="//manateelazycat.github.io/styles/post.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="//manateelazycat.github.io/styles/post_mobile.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="//manateelazycat.github.io/styles/navigatebar.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="//manateelazycat.github.io/styles/navigatebar_mobile.css">
        <link rel="stylesheet" href="//manateelazycat.github.io/theme/highlight.css">
    </head>
    <body>
        <div class="navigatebar">
    <div class="navigatebar-button navigatebar-mine">
        <a href="//manateelazycat.github.io/index.html">ManateeLazyCat</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/tags.html">Tags</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/projects.html">Projects</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/feed.xml">Feeds</a>
    </div>
    <div class="navigatebar-button navigatebar-about">
        <a href="//manateelazycat.github.io/about.html">About</a>
    </div>
</div>

        <div class="content-area">
            <div class="title">
                EAF的多线程编程模型
            </div>
            <div class="category-area">
                「
                <a href="//manateelazycat.github.io/tags.html#Emacs">
                    <div class="category">
                        Emacs
                    </div>
                </a>
                
                <a href="//manateelazycat.github.io/tags.html#EAF">
                    <div class="category">
                        EAF
                    </div>
                </a>
                」
            </div>
            <div class="char-counter">
                字数657 2021-09-22
            </div>
            <div class="content">
                <p>中科院举办的 “2021中国开源之夏”，今年EAF社区持续参与，今天在辅导同学编写新闻阅读器的过程中，同学提到了：怎么用多线程来实现后台刷新新闻数据？</p>

<p>简单整理了一下EAF怎么实现多线程的编程模型，为了方便实践，建议参考 <a href="https://github.com/emacs-eaf/eaf-file-manager">EAF file-manager</a> buffer.py 里的GitCommitThread代码实现：</p>

<ol>
  <li>QThread的原理很简单，首先创建一个 QThread 的类，然后把耗时代码丢到 run 函数中</li>
  <li>在主线程（EAF就是AppBuffer的函数）创建 QThread 的实例，为了避免调用函数作用域跳出导致 QThread 实例被销毁，可以把 QThread 实例加到一个队列对象中以保持引用 (参考 file-manager 的队列对象 fetch_git_log_threads)</li>
  <li>QThread创建好以后，直接调用 thread.start() 会在一个子线程运行耗时代码</li>
  <li>图形编程中要遵守 “子线程不能直接操作图形界面，只有主线程可以操作图形界面” 的原则，QThread中run函数完成耗时操作后，需要通过发送信号到主线程来提醒主线程刷新界面 (参考 GitCommitThread 的 fetch_command_result 信号)</li>
  <li>主线程接收到 QThread 的完成信号，调用图形代码刷新界面，为了遵守步骤4中的原则，刷新界面的回调函数需要用装饰器 @PostGui() 包装一下，保证操作界面代码只运行在主线程中 (参考 file-manager 的 update_git_log 函数)</li>
</ol>

<p>以上就是EAF中实现多线程的全部关键步骤，此原理也适用于任何Qt程序。</p>

            </div>
        </div>
    </body>
</html>
