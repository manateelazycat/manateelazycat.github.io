<!DOCTYPE html>

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
<title>Emacs + Company-Mode 配置多个补全后端</title>


        <link rel="stylesheet" href="//manateelazycat.github.io/styles/font.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="//manateelazycat.github.io/styles/post.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="//manateelazycat.github.io/styles/post_mobile.css">
        <link rel="stylesheet" media="screen and (min-width: 600px)" href="//manateelazycat.github.io/styles/navigatebar.css">
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="//manateelazycat.github.io/styles/navigatebar_mobile.css">
        <link rel="stylesheet" href="//manateelazycat.github.io/theme/highlight.css">
    </head>
    <body>
        <div class="navigatebar">
    <div class="navigatebar-button navigatebar-mine">
        <a href="//manateelazycat.github.io/index.html">ManateeLazyCat</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/tags.html">Tags</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/projects.html">Projects</a>
    </div>
    <div class="navigatebar-button">
        <a href="//manateelazycat.github.io/feed.xml">Feeds</a>
    </div>
    <div class="navigatebar-button navigatebar-about">
        <a href="//manateelazycat.github.io/about.html">About</a>
    </div>
</div>

        <div class="content-area">
            <div class="title">
                Emacs + Company-Mode 配置多个补全后端
            </div>
            <div class="category-area">
                「
                <a href="//manateelazycat.github.io/tags.html#Emacs">
                    <div class="category">
                        Emacs
                    </div>
                </a>
                」
            </div>
            <div class="char-counter">
                字数1402 2021-06-30
            </div>
            <div class="content">
                <p><a href="https://company-mode.github.io/">Company-Mode</a>是Emacs的代码补全框架，最近Emacs-China社区大神发布了<a href="https://github.com/universal-ctags/citre">Citre</a>这个全新的补全前端，基于<a href="https://ctags.io/">Universal Ctags</a>建索引的原理给开发项目提供代码补全建议。</p>

<p>这两天折腾了一下Citre，给我的感觉是：</p>
<ol>
  <li>LSP补全后端(lsp-mode, eglot, nox)针对系统库的补全更好，比如 os.path.exists 这种</li>
  <li>Ctags补全后端针对项目自研代码补全更好，而且速度比LSP快，不粘手</li>
</ol>

<p>如果我们可以同时用LSP和Ctags两个后端补全代码，就可以兼顾系统库和自研代码的代码补全。</p>

<p>早上折腾了一下，核心配置如下：</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; Customize company backends.</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">company-backends</span>
      <span class="o">'</span><span class="p">(</span>
        <span class="p">(</span><span class="nv">company-tabnine</span> <span class="nv">company-dabbrev</span> <span class="nv">company-keywords</span> <span class="nv">company-files</span> <span class="nv">company-capf</span><span class="p">)</span>
        <span class="p">))</span>

<span class="c1">;; Add yasnippet support for all company backends.</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="nv">company-mode/enable-yas</span> <span class="no">t</span>
  <span class="s">"Enable yasnippet for all backends."</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">company-mode/backend-with-yas</span> <span class="p">(</span><span class="nv">backend</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">company-mode/enable-yas</span><span class="p">)</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">listp</span> <span class="nv">backend</span><span class="p">)</span> <span class="p">(</span><span class="nb">member</span> <span class="ss">'company-yasnippet</span> <span class="nv">backend</span><span class="p">)))</span>
      <span class="nv">backend</span>
    <span class="p">(</span><span class="nb">append</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">consp</span> <span class="nv">backend</span><span class="p">)</span> <span class="nv">backend</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">backend</span><span class="p">))</span>
            <span class="o">'</span><span class="p">(</span><span class="ss">:with</span> <span class="nv">company-yasnippet</span><span class="p">))))</span>

<span class="p">(</span><span class="k">setq</span> <span class="nv">company-backends</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#'</span><span class="nv">company-mode/backend-with-yas</span> <span class="nv">company-backends</span><span class="p">))</span>

<span class="c1">;; Add `company-elisp' backend for elisp.</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">'emacs-lisp-mode-hook</span>
          <span class="nf">#'</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
              <span class="p">(</span><span class="nb">require</span> <span class="ss">'company-elisp</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">push</span> <span class="ss">'company-elisp</span> <span class="nv">company-backends</span><span class="p">)))</span>

<span class="c1">;; Remove duplicate candidate.</span>
<span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">'company-transformers</span> <span class="nf">#'</span><span class="nv">delete-dups</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>把其他company后端都放到 company-capf 之前，避免 company-capf (citre用的就是这个接口) 把其他后端的补全数据给覆盖了</li>
  <li>通过 company-tabnine 这个深度学习补全后端可以分析LSP后端数据的能力，把LSP和Citre两个后端的数据进行揉和</li>
  <li>通过 ‘company-mode/backend-with-yas 建议，利用 company-mode 的 :with 关键字，把所有语言的模板补全后端进行二次揉和</li>
  <li>编辑Elisp文件时，临时增加 company-elisp 这个补全后端</li>
  <li>删除多个后端间重复的补全选项</li>
</ol>

<p><img src="//manateelazycat.github.io/pics/company-multiple-backends/tabnine.png" alt="LSP补全后端" /></p>

<p><img src="//manateelazycat.github.io/pics/company-multiple-backends/citre.png" alt="Ctags补全后端" /></p>

<p>详细的配置请访问 https://github.com/manateelazycat/lazycat-emacs/blob/8f3dee8a6fe724ec52cd2b17155cfc2cefc8066b/site-lisp/config/init-company-mode.el</p>

            </div>
        </div>
    </body>
</html>
