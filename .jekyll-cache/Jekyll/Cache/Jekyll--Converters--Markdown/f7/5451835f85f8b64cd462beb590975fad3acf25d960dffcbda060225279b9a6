I"DÆ<h3 id="ä¸ºä»€ä¹ˆè¦åšæ·±åº¦ç³»ç»Ÿç›‘è§†å™¨">ä¸ºä»€ä¹ˆè¦åšæ·±åº¦ç³»ç»Ÿç›‘è§†å™¨ï¼Ÿ</h3>
<p>ä¸ºäº†è¾¾åˆ°æ·±åº¦æ“ä½œç³»ç»ŸUI/UXå¤§ç»Ÿä¸€çš„â€˜é›„ä¼Ÿâ€™ç›®æ ‡ï¼Œé—²æ¥æ— äº‹å†™äº†æ·±åº¦ç³»ç»Ÿç›‘è§†å™¨ï¼Œå…ˆå‘ä¸€å¼ å›¾é•‡æ¥¼ï¼Œå“ˆå“ˆå“ˆã€‚</p>

<p><img src="http://localhost:4000/pics/deepin-system-monitor/deepin-system-monitor-1.png" alt="" /></p>

<p>ç¤¾åŒºçš„å¼€æºçˆ±å¥½è€…é©¬ä¸Šä¼šè·³å‡ºæ¥è¯´ï¼Œæ·±åº¦ä½ ä»¬åˆé€ è½®å­ï¼Œä½ ä»¬é€ çš„è½®å­æ¯”Gnomeå’ŒKDEçš„ç³»ç»Ÿç›‘è§†å™¨å¥½å—ï¼Ÿ</p>

<p>å›ç­”å½“ç„¶æ˜¯è‚¯å®šçš„ï¼Œå¦‚æœä¸ç§’æ€Gnomeçš„ç³»ç»Ÿç›‘è§†å™¨æˆ‘é€ å®ƒå¹²å˜›å‘¢ï¼Ÿ</p>

<p>æ·±åº¦ç³»ç»Ÿç›‘è§†å™¨é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šæé«˜ç”¨æˆ·æ“ä½œçš„æ˜“ç”¨æ€§
Gnomeçš„ç³»ç»Ÿç›‘è§†å™¨é»˜è®¤åˆ†å¼€äº†ä¸‰ä¸ªæ ‡ç­¾ï¼ŒæŠŠè¿›ç¨‹åˆ—è¡¨å’Œèµ„æºæ€»è§ˆåˆ†å¼€äº†ï¼Œçœ‹è¿›ç¨‹åˆ—è¡¨çš„çŠ¶æ€å°±ä¸çŸ¥é“èµ„æºæ€»è§ˆçš„ä¿¡æ¯ï¼Œçœ‹èµ„æºæ€»è§ˆä¿¡æ¯å°±ä¸çŸ¥é“è¿›ç¨‹åˆ—è¡¨çš„çŠ¶æ€ï¼Œè€Œä¸”è¿˜åœ¨ç¬¬ä¸‰ä¸ªæ ‡ç­¾æä¾›äº†ä¸€ä¸ªé¸¡è‚‹çš„ç£ç›˜è®¾å¤‡çš„ç©ºé—´ï¼Œåªèƒ½çœ‹å•¥æ“ä½œéƒ½ä¸èƒ½åšï¼Œè¿˜ä¸å¦‚æ”¾åœ¨æ–‡ä»¶ç®¡ç†å™¨æˆ–è€…ç£ç›˜ç®¡ç†å·¥å…·é‡Œé¢ã€‚</p>

<p><img src="http://localhost:4000/pics/deepin-system-monitor/deepin-system-monitor-2.png" alt="" /></p>

<p><img src="http://localhost:4000/pics/deepin-system-monitor/deepin-system-monitor-3.png" alt="" /></p>

<p>æ‰€ä»¥é’ˆå¯¹è¿™äº›ä¸çˆ½çš„è®¾è®¡ï¼Œæ·±åº¦ç³»ç»Ÿç›‘è§†å™¨æŠŠèµ„æºæ€»è§ˆä¿¡æ¯å’Œåˆ—è¡¨çš„è¿›ç¨‹ä¿¡æ¯æ”¾åœ¨ä¸€èµ·ï¼Œä¸€çœ¼å°±å¯ä»¥çŸ¥é“ç°åœ¨ç”µè„‘çš„æ•´ä½“è´Ÿè½½ï¼Œè€Œä¸”ç”¨æˆ·é©¬ä¸Šå°±å¯ä»¥åœ¨å³è¾¹æŸ¥çœ‹é«˜èµ„æºå ç”¨çš„è¿›ç¨‹ï¼Œå†ä¹Ÿä¸ç”¨æ¥å›è´¹åŠ²çš„åˆ‡æ¢æ ‡ç­¾å»çœ‹è¿™ä¸¤ä¸ªæœ¬æ¥å°±åº”è¯¥åœ¨ä¸€èµ·çš„ä¿¡æ¯ã€‚</p>

<p>å…¶æ¬¡ï¼Œæ·±åº¦ç³»ç»Ÿç›‘è§†å™¨ç‹ ä¸‹å†…åŠŸï¼Œä¸ä½†å¯ä»¥å¯¹æ¯ä¸ªè¿›ç¨‹çš„CPUã€å†…å­˜çŠ¶æ€è¿›è¡Œç›‘æ§ï¼Œè¿˜å¯ä»¥å®æ—¶æŸ¥çœ‹æ¯ä¸ªè¿›ç¨‹çš„ç£ç›˜IOæ“ä½œå’Œç½‘ç»œæ“ä½œï¼Œä¸€çœ¼å°±çŸ¥é“å“ªäº›è¿›ç¨‹åœ¨ç‹‚å†™ç¡¬ç›˜å’Œåœ¨åå°å·å·ä¸‹è½½äº†ã€‚</p>

<p>æœ€åï¼Œè¿˜æä¾›ä¸€äº›å°è´´å¿ƒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚æŸ¥æ‰¾è¿›ç¨‹å¯åŠ¨å‘½ä»¤æ‰€åœ¨çš„ä½ç½®ï¼ˆç”šè‡³åŒ…æ‹¬Wineç¨‹åºéƒ½å¯ä»¥è½»æ¾æ‰¾åˆ°ï¼‰å’Œç±»ä¼¼xkillçš„åŠŸèƒ½ï¼ˆç‚¹å“ªæ€å“ªï¼‰ã€‚</p>

<h3 id="æŠ€æœ¯åŸç†å‰–æ">æŠ€æœ¯åŸç†å‰–æ</h3>
<p>ä»Šå¤©ä¸»è¦å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å¯¹è¿›ç¨‹ä¿¡æ¯è¿›è¡Œç›‘å¬çš„åŸç†å’Œå®ç°ã€‚</p>

<p>åœ¨Linuxä¸­ï¼Œè®¡ç®—æœºçš„æ‰€æœ‰æ•°æ®çš„è®¡ç®—éƒ½é€šè¿‡è¯»å–åˆ†æ /proc æ–‡ä»¶ç³»ç»Ÿæ¥å®ç°ï¼ŒLinuxå†…æ ¸ä¼šå®æ—¶æŠŠç¡¬ä»¶çš„çŠ¶å†µæ›´æ–°åˆ° /proc è¿™ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹ /proc ä¸åŒçš„éƒ¨åˆ†è¿›è¡ŒåŸç†å’ŒæŠ€æœ¯å®ç°å‰–æï¼š</p>

<h4 id="è®¡ç®—æ€»cpuæ•°æ®">è®¡ç®—æ€»CPUæ•°æ®</h4>
<p>å¾—åˆ°è®¡ç®—æœºçš„æ€»CPUæ•°æ®æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è¯»å– /proc/stat æ–‡ä»¶å³å¯ï¼Œæ¯”å¦‚åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/stat
</code></pre></div></div>

<p>å³å¯å¾—åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cpu  492210 2258 105266 10955786 187778 0 4761 0 0 0
cpu0 89150 320 19660 1276610 76551 0 3102 0 0 0
cpu1 41252 241 10276 1403886 14385 0 350 0 0 0
cpu2 76932 339 16603 1343444 27821 0 678 0 0 0
cpu3 43124 243 8810 1408410 11182 0 143 0 0 0
cpu4 78072 320 16240 1350574 20070 0 215 0 0 0
cpu5 43333 244 8818 1407601 11858 0 77 0 0 0
cpu6 76218 318 15967 1355511 17012 0 139 0 0 0
cpu7 44126 230 8890 1409746 8896 0 55 0 0 0
intr 29214339 19 61901 0 0 0 0 0 0 1 8821 0 0 9987 0 0 0 29 0 1 0 0 0 0 35 0 0 22 7383 136 199974 241715 561627 23 546066 397 746 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
ctxt 92198094
btime 1500712714
processes 36267
procs_running 4
procs_blocked 0
softirq 13122555 137 4225618 144 671154 238659 0 62530 4265310 0 3659003
</code></pre></div></div>
<p>ç¬¬ä¸€è¡Œå°±æ˜¯æ€»CPUçš„å ç”¨ç‡ï¼Œä¸‹é¢çš„CPU1ã€CPU2ç­‰ç­‰è¡¨ç¤ºå¤šæ ¸CPUæŸä¸ªæ ¸çš„CPUå æœ‰ç‡ã€‚
ç¬¬ä¸€è¡Œä»å·¦åˆ°å³çš„æ•°å€¼åˆ†åˆ«è¡¨ç¤ºï¼šuser, nice, system, idle, iowait, irq, softirq, steal, guest, guestnice ï¼ˆè¿™äº›å€¼åˆ†åˆ«ä»£è¡¨çš„æ„ä¹‰åœ¨manæ‰‹å†Œé‡Œé¢éƒ½æœ‰è®²ï¼Œä»Šå¤©å°±ä¸å±•å¼€äº†ï¼‰
è®¡ç®—æ€»CPUçš„å æœ‰ç‡ï¼Œé¦–å…ˆè¦è®¡ç®— workTimeå’ŒtotalTime:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">workTime</span> <span class="o">=</span> <span class="n">user</span> <span class="o">+</span> <span class="n">nice</span> <span class="o">+</span> <span class="n">system</span><span class="p">;</span>
<span class="n">totalTime</span> <span class="o">=</span>  <span class="k">return</span> <span class="n">user</span> <span class="o">+</span> <span class="n">nice</span> <span class="o">+</span> <span class="n">system</span> <span class="o">+</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">iowait</span> <span class="o">+</span> <span class="n">irq</span> <span class="o">+</span> <span class="n">softirq</span> <span class="o">+</span> <span class="n">steal</span><span class="p">;</span>
</code></pre></div></div>
<p>æ¯”å¦‚æˆ‘ä»¬ç³»ç»Ÿç›‘è§†å™¨2ç§’ä¸­è·å–ä¸€äº›å½“å‰CPUæ—¶é—´çš„åˆ‡ç‰‡ï¼Œæœ€åè®¡ç®—CPUå æœ‰ç‡çš„å…¬å¼å°±æ˜¯ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cpuPercent</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentWorkTime</span> <span class="o">-</span> <span class="n">prevWorkTime</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">currentTotalTime</span> <span class="o">-</span> <span class="n">prevTotalTime</span><span class="p">)</span>
</code></pre></div></div>
<p>currentWorkTimeå’ŒcurrentTotalTimeè¡¨ç¤ºå½“å‰çš„CPUæ—¶é—´
prevWorkTimeå’ŒprevTotalTimeè¡¨ç¤º2ç§’å‰çš„CPUæ—¶é—´</p>

<p>å–å¾—CPUæ—¶é—´çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">getTotalCpuTime</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">workTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"/proc/stat"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"Could not open stat file"</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">user</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1">// added between Linux 2.5.41 and 2.6.33, see man proc(5)</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">iowait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">softirq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">steal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">guest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">guestnice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="kt">char</span><span class="o">*</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"Could not read stat file"</span><span class="p">);</span>
            <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

        <span class="n">sscanf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
               <span class="s">"cpu  %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu %16llu"</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">system</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iowait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">softirq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">steal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guestnice</span><span class="p">);</span>

        <span class="n">workTime</span> <span class="o">=</span> <span class="n">user</span> <span class="o">+</span> <span class="n">nice</span> <span class="o">+</span> <span class="n">system</span><span class="p">;</span>

        <span class="c1">// sum everything up (except guest and guestnice since they are already included</span>
        <span class="c1">// in user and nice, see http://unix.stackexchange.com/q/178045/20626)</span>
        <span class="k">return</span> <span class="n">user</span> <span class="o">+</span> <span class="n">nice</span> <span class="o">+</span> <span class="n">system</span> <span class="o">+</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">iowait</span> <span class="o">+</span> <span class="n">irq</span> <span class="o">+</span> <span class="n">softirq</span> <span class="o">+</span> <span class="n">steal</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>å…·ä½“å¯ä»¥å‚è€ƒ: https://github.com/manateelazycat/deepin-system-monitor/blob/master/src/utils.cpp</p>

<h4 id="è®¡ç®—æ€»å†…å­˜æ•°æ®">è®¡ç®—æ€»å†…å­˜æ•°æ®</h4>
<p>è®¡ç®—æœºæ€»å†…å­˜çš„æ•°æ®ä¿å­˜åœ¨ /proc/meminfo æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/meminfo
</code></pre></div></div>

<p>å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¿¡æ¯ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MemTotal:        8056276 kB
MemFree:          897868 kB
MemAvailable:    4861656 kB
Buffers:          143776 kB
Cached:          4613124 kB
SwapCached:            0 kB
Active:          3455196 kB
Inactive:        3220984 kB
Active<span class="o">(</span>anon<span class="o">)</span>:    1932732 kB
Inactive<span class="o">(</span>anon<span class="o">)</span>:   736476 kB
Active<span class="o">(</span>file<span class="o">)</span>:    1522464 kB
Inactive<span class="o">(</span>file<span class="o">)</span>:  2484508 kB
Unevictable:          48 kB
Mlocked:              48 kB
SwapTotal:      36042872 kB
SwapFree:       36042872 kB
Dirty:               356 kB
Writeback:             0 kB
AnonPages:       1919408 kB
Mapped:           888900 kB
Shmem:            749924 kB
Slab:             313304 kB
SReclaimable:     262640 kB
SUnreclaim:        50664 kB
KernelStack:       12960 kB
PageTables:        55112 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:    40071008 kB
Committed_AS:    8831548 kB
VmallocTotal:   34359738367 kB
VmallocUsed:           0 kB
VmallocChunk:          0 kB
HardwareCorrupted:     0 kB
AnonHugePages:         0 kB
ShmemHugePages:        0 kB
ShmemPmdMapped:        0 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:      233872 kB
DirectMap2M:     8032256 kB
DirectMap1G:           0 kB
</code></pre></div></div>
<p>æˆ–è€…é€šè¿‡å‘½ä»¤ free å¾—åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              total        used        free      shared  buff/cache   available
Mem:        8056276     2167084      861736      756536     5027456     4826836
Swap:      36042872           0    36042872
</code></pre></div></div>

<p>è®¡ç®—å†…å­˜çš„å æœ‰å°±è¦ç®€å•çš„å¾ˆå¤šï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memoryPercent <span class="o">=</span> <span class="o">(</span>total - available<span class="o">)</span> <span class="k">*</span> 100.0 / total
</code></pre></div></div>

<p>æ³¨æ„ï¼Œå½“å‰ç³»ç»Ÿä½¿ç”¨çš„å†…å­˜æ˜¯ç”±å†…å­˜æ€»é‡totalå‡å»å¯ç”¨å†…å­˜aviailableçš„å€¼æ¥è®¡ç®—çš„ï¼Œä¸èƒ½ç”¨</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memoryPercent <span class="o">=</span> used <span class="k">*</span> 100.0 / total
</code></pre></div></div>

<p>å› ä¸º used çš„å€¼ä¸åŒ…æ‹¬ä¸€äº›è¢«å†…æ ¸å ç”¨å¹¶ä¸”æ°¸ä¸é‡Šæ”¾çš„ç¼“å­˜å†…å­˜ï¼Œå¦‚æœç”¨ used çš„æ–¹å¼æ¥è®¡ç®—å†…å­˜ç™¾åˆ†æ¯”ï¼Œä¼šå‘ç°æœ€ç»ˆè®¡ç®—çš„ç»“æœä¼šæ¯”å®é™…å ç”¨çš„å†…å­˜å° 15% å·¦å³ã€‚</p>

<p>å…·ä½“çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬ç”¨ libprocps-dev è¿™ä¸ªå¼€å‘åº“æä¾›çš„ meminfo() å‡½æ•°ï¼Œç„¶åç›´æ¥è¯»å– kb_main_total å’Œ kb_main_available å°±å¯ä»¥äº†ï¼Œäº¤æ¢ç©ºé—´è¯»å– kb_swap_used å’Œ kb_swap_total è¿™ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚
å‚è€ƒä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">meminfo</span><span class="p">();</span>

<span class="n">memoryPercent</span> <span class="o">=</span> <span class="p">(</span><span class="n">kb_main_total</span> <span class="o">-</span> <span class="n">kb_main_available</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">kb_main_total</span>
<span class="n">swapPercent</span> <span class="o">=</span> <span class="n">kb_swap_used</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">kb_swap_total</span>
</code></pre></div></div>

<h4 id="è®¡ç®—æ€»ç½‘ç»œæ•°æ®">è®¡ç®—æ€»ç½‘ç»œæ•°æ®</h4>
<p>è®¡ç®—æœºæ€»ç½‘ç»œæ•°æ®å¯ä»¥é€šè¿‡è¯»å–åˆ†æ /proc/net/dev æ–‡ä»¶æ¥è®¡ç®—, æ‰§è¡Œå‘½ä»¤å</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/net/dev
</code></pre></div></div>

<p>å¯ä»¥å¾—åˆ°ç±»ä¼¼çš„æ•°æ®ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
enp0s25:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
    lo: 65691844  116033    0    0    0     0          0         0 65691844  116033    0    0    0     0       0          0
wlp4s0: 1249471414  907278    0    0    0     0          0         0 88564991  428056    0    0    0     0       0          0
</code></pre></div></div>

<p>è¿™ä¸ªæ–‡ä»¶çš„æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—ç½‘ç»œè®¾å¤‡çš„ç¬¬ä¸€ä¸ªå’Œç¬¬ä¹ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºä¸‹è½½çš„æ€»byteæ•°ï¼Œç¬¬ä¹ä¸ªå€¼è¡¨ç¤ºä¸Šä¼ çš„æ€»byteæ•°ã€‚
åŸç†å°±æ˜¯è¯»å– /proc/net/dev çš„ç½‘ç»œè®¾å¤‡çš„ä¸‹è½½å’Œä¸Šä¼ æ•°æ®ï¼ŒåŠ åœ¨ä¸€èµ·æ±‚å’Œï¼ŒåŒæ—¶è¦æ’é™¤ lo è¿™ä¸ªè™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">getNetworkBandWidth</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">receiveBytes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">sendBytes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
        <span class="k">static</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">;</span>
        <span class="kt">FILE</span> <span class="o">*</span><span class="n">devfd</span><span class="p">;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
        <span class="n">devfd</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"/proc/net/dev"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

        <span class="c1">// Ignore the first two lines of the file.</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">devfd</span><span class="p">);</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">devfd</span><span class="p">);</span>

        <span class="n">receiveBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sendBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">devfd</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">rBytes</span><span class="p">,</span> <span class="n">sBytes</span><span class="p">;</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

            <span class="kt">char</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">":"</span><span class="p">);</span>

            <span class="c1">// Filter lo (virtual network device).</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">trimmed</span><span class="p">()</span> <span class="o">!=</span> <span class="s">"lo"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"%llu %*d %*d %*d %*d %*d %*d %*d %llu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rBytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sBytes</span><span class="p">);</span>

                <span class="n">receiveBytes</span> <span class="o">+=</span> <span class="n">rBytes</span><span class="p">;</span>
                <span class="n">sendBytes</span> <span class="o">+=</span> <span class="n">sBytes</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">fclose</span><span class="p">(</span><span class="n">devfd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬åªç”¨æ¯2ç§’è®¡ç®—ä¸€ä¸‹å†…å­˜çš„æ€»ä¸Šä¼ å’Œä¸‹è½½byteæ•°å°±å¯ä»¥å¾—çŸ¥ç³»ç»Ÿæ€»å…±ä¸‹è½½å’Œä¸Šä¼ çš„å¸¦å®½ï¼Œæ€»çš„ä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦å°±æ›´ç®€å•äº†ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">downloadSpeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentDownloadBytes</span> <span class="o">-</span> <span class="n">prevDownloadBytes</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span>
<span class="n">uploadSpeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentUploadBytes</span> <span class="o">-</span> <span class="n">prevUploadBytes</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span>
</code></pre></div></div>

<h4 id="è®¡ç®—è¿›ç¨‹çš„cpuå’Œå†…å­˜æ•°æ®">è®¡ç®—è¿›ç¨‹çš„CPUå’Œå†…å­˜æ•°æ®</h4>
<p>è®¡ç®—è¿›ç¨‹çš„CPUæ¯”è¾ƒç®€å•ï¼Œç±»ä¼¼æ€»CPUçš„è®¡ç®—æ–¹å¼ï¼Œåªæ˜¯ç”¨è¿›ç¨‹è‡ªå·±çš„CPUå€¼æ¥è®¡ç®—ï¼Œ è¿›ç¨‹è‡ªå·±çš„CPUå€¼é€šè¿‡è¯»å– /proc/pid/stat æ¥è¯»å–ã€‚
è¿›ç¨‹çš„å†…å­˜ä¿¡æ¯ä¹Ÿæ˜¯ä» /proc/pid/stat æ–‡ä»¶ä¸­è¯»å–ã€‚
å…·ä½“çš„ä»£ç å®ç°è¯·å‚è€ƒï¼šhttps://github.com/manateelazycat/deepin-system-monitor/blob/master/src/status_monitor.cpp</p>

<h4 id="è®¡ç®—è¿›ç¨‹çš„ç£ç›˜ioæ•°æ®">è®¡ç®—è¿›ç¨‹çš„ç£ç›˜IOæ•°æ®</h4>
<p>è®¡ç®—è¿›ç¨‹çš„ç£ç›˜IOæ•°æ®ä¸»è¦é€šè¿‡è¯»å– /proc/pid/io æ–‡ä»¶çš„å†…å®¹æ¥è§£æï¼Œ æ‰§è¡Œå‘½ä»¤å</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cat</span> /proc/pid/io
</code></pre></div></div>

<p>ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rchar: 2511751
wchar: 115513
syscr: 18106
syscw: 2864
read_bytes: 0
write_bytes: 0
cancelled_write_bytes: 0
</code></pre></div></div>
<p>æˆ‘ä»¬åªç”¨æ³¨æ„ rchar å’Œ wcharè¿™ä¸¤ä¸ªå€¼ï¼Œ rcharä»£è¡¨è¿›ç¨‹çš„å†™å…¥å­—ç¬¦æ•°ã€wcharä»£è¡¨è¿›ç¨‹è¯»å–å­—ç¬¦æ•°ï¼Œç£ç›˜IOå°±å¾ˆå®¹è®¡ç®—ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">readKbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentReadChar</span> <span class="o">-</span> <span class="n">prevReadChar</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="n">writeKbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentWriteChar</span> <span class="o">-</span> <span class="n">prevWriteChar</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">1000</span>
</code></pre></div></div>

<p>å…·ä½“çš„ä»£ç å®ç°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">bool</span> <span class="nf">getProcPidIO</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ProcPidIO</span> <span class="o">&amp;</span><span class="n">io</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">"/proc/"</span> <span class="o">&lt;&lt;</span> <span class="n">pid</span> <span class="o">&lt;&lt;</span> <span class="s">"/io"</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">ifs</span><span class="p">(</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">ifs</span><span class="p">.</span><span class="n">good</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span> <span class="n">ifs</span><span class="p">.</span><span class="n">good</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ifs</span><span class="p">.</span><span class="n">eof</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s</span><span class="p">;</span>
                <span class="n">getline</span><span class="p">(</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">s</span> <span class="p">);</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"rchar: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">rchar</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"wchar: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">wchar</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"syscr: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">syscr</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"syscw: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">syscw</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"read_bytes: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">read_bytes</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"write_bytes: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">write_bytes</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">sscanf</span><span class="p">(</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"cancelled_write_bytes: %lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">cancelled_write_bytes</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

<span class="n">DiskStatus</span> <span class="n">StatusMonitor</span><span class="o">::</span><span class="n">getProcessDiskStatus</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ProcPidIO</span> <span class="n">pidIO</span><span class="p">;</span>
    <span class="n">getProcPidIO</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">pidIO</span><span class="p">);</span>

    <span class="n">DiskStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">processWriteKbs</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">status</span><span class="p">.</span><span class="n">writeKbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pidIO</span><span class="p">.</span><span class="n">wchar</span> <span class="o">-</span> <span class="n">processWriteKbs</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">updateDuration</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">(</span><span class="o">*</span><span class="n">processWriteKbs</span><span class="p">)[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidIO</span><span class="p">.</span><span class="n">wchar</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">processReadKbs</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">status</span><span class="p">.</span><span class="n">readKbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pidIO</span><span class="p">.</span><span class="n">rchar</span> <span class="o">-</span> <span class="n">processReadKbs</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">updateDuration</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">(</span><span class="o">*</span><span class="n">processReadKbs</span><span class="p">)[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidIO</span><span class="p">.</span><span class="n">rchar</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="è®¡ç®—è¿›ç¨‹çš„ç½‘ç»œioæ•°æ®">è®¡ç®—è¿›ç¨‹çš„ç½‘ç»œIOæ•°æ®</h4>
<p>è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ç½‘ç»œIOæ•°æ®æ¯”è¾ƒå¤æ‚ï¼ŒåŸç†æ­¥éª¤å¦‚ä¸‹ï¼š
1ã€è·å–è¿›ç¨‹çš„æ‰€æœ‰TCPé“¾æ¥çš„inode, /proc/pid/fd ç›®å½•ä¸‹ä»£è¡¨å½“å‰è¿›ç¨‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬ä¸¾ä¾‹ç½‘æ˜“äº‘éŸ³ä¹çš„è¿›ç¨‹ï¼Œå†…å®¹ç±»ä¼¼ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>andy@andy-PC:~/deepin-system-monitor/build<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /proc/22269/fd
æ€»ç”¨é‡ 0
dr-x------ 2 andy andy  0 7æœˆ  22 17:18 <span class="nb">.</span>
dr-xr-xr-x 9 andy andy  0 7æœˆ  22 17:11 ..
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 0 -&gt; pipe:[139620]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 1 -&gt; /dev/null
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 10 -&gt; socket:[141559]
lrwx------ 1 andy andy 64 7æœˆ  22 17:21 100 -&gt; socket:[564075]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 101 -&gt; /dev/shm/.org.chromium.Chromium.NLubPR <span class="o">(</span>deleted<span class="o">)</span>
l-wx------ 1 andy andy 64 7æœˆ  22 17:32 102 -&gt; /home/andy/.cache/netease-cloud-music/AlbumCover/4e3830fa33b1caf266bfe8ff6acd7634.tmp <span class="o">(</span>deleted<span class="o">)</span>
l-wx------ 1 andy andy 64 7æœˆ  22 17:32 103 -&gt; /home/andy/.cache/netease-cloud-music/CachedSongs/4176388-320-7c00bba57b7a737c8047bb11bd07827d.mp3.tmp <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:32 104 -&gt; socket:[751267]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 105 -&gt; socket:[751268]
lrwx------ 1 andy andy 64 7æœˆ  22 17:21 106 -&gt; socket:[756879]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 11 -&gt; socket:[141560]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 110 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 111 -&gt; /dev/shm/.org.chromium.Chromium.8IQyY6 <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 112 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/Local Storage/orpheus_orpheus_0.localstorage
lrwx------ 1 andy andy 64 7æœˆ  22 17:24 115 -&gt; socket:[753243]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 116 -&gt; socket:[753244]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 117 -&gt; pipe:[753245]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 118 -&gt; anon_inode:[eventfd]
l-wx------ 1 andy andy 64 7æœˆ  22 17:21 119 -&gt; pipe:[753245]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 12 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 120 -&gt; socket:[753248]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 121 -&gt; anon_inode:[eventfd]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 122 -&gt; /dev/urandom
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 123 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 13 -&gt; anon_inode:[eventfd]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 14 -&gt; anon_inode:inotify
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 15 -&gt; socket:[143624]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 16 -&gt; /usr/lib/netease-cloud-music/icudtl.dat
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 17 -&gt; /usr/lib/netease-cloud-music/snapshot_blob.bin
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 18 -&gt; /usr/lib/netease-cloud-music/natives_blob.bin
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 19 -&gt; /usr/lib/netease-cloud-music/locales/zh-CN.pak
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 2 -&gt; /dev/null
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 20 -&gt; /usr/lib/netease-cloud-music/cef.pak
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 21 -&gt; /usr/lib/netease-cloud-music/cef_100_percent.pak
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 22 -&gt; /usr/lib/netease-cloud-music/cef_200_percent.pak
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 23 -&gt; anon_inode:inotify
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 24 -&gt; /usr/lib/netease-cloud-music/cef_extensions.pak
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 25 -&gt; socket:[141561]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 26 -&gt; socket:[141562]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 27 -&gt; pipe:[141563]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 28 -&gt; pipe:[141563]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 29 -&gt; socket:[141564]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 3 -&gt; socket:[141558]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 30 -&gt; socket:[141605]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 31 -&gt; pipe:[140610]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 32 -&gt; pipe:[140610]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 33 -&gt; anon_inode:[eventpoll]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 34 -&gt; socket:[137178]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 35 -&gt; socket:[137179]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 36 -&gt; pipe:[137180]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 37 -&gt; pipe:[137180]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 38 -&gt; socket:[137181]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 39 -&gt; anon_inode:inotify
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 4 -&gt; anon_inode:[eventfd]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 40 -&gt; pipe:[137189]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 41 -&gt; pipe:[137189]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 42 -&gt; anon_inode:[eventpoll]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 43 -&gt; socket:[137190]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 44 -&gt; socket:[137191]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 45 -&gt; pipe:[137192]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 46 -&gt; pipe:[137192]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 47 -&gt; anon_inode:[eventpoll]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 48 -&gt; anon_inode:[eventpoll]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 49 -&gt; socket:[131820]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 5 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 50 -&gt; socket:[131821]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 51 -&gt; socket:[137193]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 52 -&gt; socket:[137194]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 53 -&gt; pipe:[137195]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 54 -&gt; pipe:[137195]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 55 -&gt; pipe:[131822]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 56 -&gt; pipe:[131822]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 57 -&gt; pipe:[140611]
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 58 -&gt; pipe:[140611]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 59 -&gt; socket:[140614]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 6 -&gt; socket:[138694]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 60 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 61 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 62 -&gt; socket:[137196]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 63 -&gt; /dev/urandom
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 64 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 65 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/Visited Links
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 66 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/Cookies
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 67 -&gt; /home/andy/.cache/netease-cloud-music/Logs/webview.log
l-wx------ 1 andy andy 64 7æœˆ  22 17:18 68 -&gt; /home/andy/.cache/netease-cloud-music/Logs/web-statis.log
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 69 -&gt; socket:[143663]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 7 -&gt; anon_inode:inotify
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 70 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 71 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 72 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 73 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 74 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 75 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 76 -&gt; /home/andy/.pki/nssdb/cert9.db
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 77 -&gt; /home/andy/.pki/nssdb/key4.db
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 78 -&gt; /home/andy/.config/netease-cloud-music/OfflineLibrary.db
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 79 -&gt; anon_inode:inotify
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 8 -&gt; anon_inode:[eventfd]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 80 -&gt; /home/andy/.config/netease-cloud-music/OfflineLibrary.db
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 81 -&gt; socket:[141607]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 82 -&gt; socket:[141608]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 83 -&gt; anon_inode:inotify
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 84 -&gt; /home/andy/.config/netease-cloud-music/OnlineLibrary.db
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 85 -&gt; /dev/dri/card1
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 86 -&gt; socket:[140638]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 87 -&gt; socket:[754448]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 88 -&gt; socket:[140640]
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 89 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/index
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 9 -&gt; socket:[143622]
lr-x------ 1 andy andy 64 7æœˆ  22 17:18 90 -&gt; /dev/shm/.org.chromium.Chromium.hjPeWY <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 91 -&gt; /dev/shm/.org.chromium.Chromium.hjPeWY <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 92 -&gt; /dev/shm/.org.chromium.Chromium.gSxJ28 <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 93 -&gt; /dev/shm/.org.chromium.Chromium.zxWAqZ <span class="o">(</span>deleted<span class="o">)</span>
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 94 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/data_0
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 95 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/data_1
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 96 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/data_2
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 97 -&gt; /home/andy/.cache/netease-cloud-music/Cef/Cache/data_3
lr-x------ 1 andy andy 64 7æœˆ  22 17:21 98 -&gt; /home/andy/.cache/netease-cloud-music/Logs/web-statis-tmp.log.zip
lrwx------ 1 andy andy 64 7æœˆ  22 17:18 99 -&gt; anon_inode:[eventfd]
</code></pre></div></div>

<p>æ³¨æ„é‚£äº›ä»¥ socket:[number] çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ è¿™äº›socketå¼€å¤´çš„æ–‡ä»¶æè¿°ç¬¦å°±å¯¹åº”ä¸€ä¸ª TCP é“¾æ¥ï¼Œåé¢çš„æ•°å­—å°±ä»£è¡¨é“¾æ¥å¯¹åº”çš„ TCP inodeã€‚
2ã€åˆ—å‡ºç³»ç»Ÿä¸­ TCP inode å¯¹åº”çš„é“¾æ¥ä¿¡æ¯ï¼Œé€šè¿‡å‘½ä»¤</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/net/tcp
</code></pre></div></div>

<p>å¯ä»¥å¾—åˆ°å½“å‰ TCP inode å¯¹åº”çš„é“¾æ¥ä¿¡æ¯åˆ—è¡¨ï¼Œå†…å®¹ç±»ä¼¼ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sl  local_address rem_address   st tx_queue rx_queue <span class="nb">tr </span>tm-&gt;when retrnsmt   uid  <span class="nb">timeout </span>inode
   0: 00000000:008B 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 25701 1 ffff89bc3387a7c0 100 0 0 10 0
   1: 0100007F:0277 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 21108 1 ffff89bc2d91e7c0 100 0 0 10 0
   2: 0100007F:0438 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1000        0 118922 1 ffff89bb9e326040 100 0 0 10 0
   3: 00000000:01BD 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 25700 1 ffff89bc3387a040 100 0 0 10 0
   4: DEC7A8C0:9E7E AFFD3267:20C4 01 00000000:00000000 00:00000000 00000000  1000        0 760162 1 ffff89bb9e208000 37 4 9 10 12
   5: 0100007F:0438 0100007F:D934 01 00000000:00000000 00:00000000 00000000  1000        0 760161 1 ffff89ba60483000 20 4 4 10 <span class="nt">-1</span>
   6: DEC7A8C0:D9A0 06C7FCDF:1773 01 00000000:00000000 02:00000B05 00000000  1000        0 564075 2 ffff89bb5aced7c0 22 4 29 10 <span class="nt">-1</span>
   7: DEC7A8C0:9E82 AFFD3267:20C4 01 00000000:00000000 00:00000000 00000000  1000        0 758410 1 ffff89ba0fa4f7c0 57 4 32 18 13
   8: DEC7A8C0:B9B8 7DFD1EC0:01BB 01 00000000:00000000 02:00000359 00000000  1000        0 660202 2 ffff89ba989fa800 58 4 25 10 <span class="nt">-1</span>
   9: 0100007F:D938 0100007F:0438 01 00000000:00000000 02:000006AA 00000000  1000        0 759339 2 ffff89ba6582d800 20 4 30 10 <span class="nt">-1</span>
  10: DEC7A8C0:A9D6 42522477:0050 01 00000000:00063C60 00:00000000 00000000  1000        0 759725 1 ffff89bbb8d87080 20 4 0 10 <span class="nt">-1</span>
  11: DEC7A8C0:CAF0 3C011434:01BB 01 00000000:00000000 02:0000089A 00000000  1000        0 564925 2 ffff89bb7c5fd800 72 4 30 10 <span class="nt">-1</span>
  12: DEC7A8C0:CFC6 DADCDF36:01BB 01 00000000:00000000 02:00000EB7 00000000  1000        0 565035 2 ffff89bb071aa040 22 4 28 10 <span class="nt">-1</span>
  13: 0100007F:0438 0100007F:D938 01 00000000:00000000 00:00000000 00000000  1000        0 758409 1 ffff89ba6582d080 21 4 20 10 <span class="nt">-1</span>
  14: 0100007F:D934 0100007F:0438 01 00000000:00000000 02:000002F2 00000000  1000        0 759243 2 ffff89bb6d885080 20 4 11 10 <span class="nt">-1</span>
  15: DEC7A8C0:E168 5D39C834:01BB 01 00000000:00000000 02:000005E2 00000000  1000        0 565468 2 ffff89bbb8d0f780 57 4 30 10 <span class="nt">-1</span>
  16: DEC7A8C0:D898 C5A06F3B:0050 08 00000000:00000001 02:00000734 00000000  1000        0 761352 2 ffff89ba989fa080 22 4 24 10 <span class="nt">-1</span>
  17: DEC7A8C0:93B2 5B822879:1F92 01 00000000:00000000 02:00000226 00000000  1000        0 566332 2 ffff89bb05284780 22 4 28 10 <span class="nt">-1</span>
</code></pre></div></div>
<p>3ã€ä½¿ç”¨ libcap æŠ“åŒ…çš„æ–¹æ³•ï¼Œè®¡ç®—å‡ºæ¯ä¸ªTCPé“¾æ¥å¯¹åº”çš„ç½‘ç»œæµé‡åï¼Œç„¶ååå‘é€šè¿‡æ­¥éª¤ä¸€çš„ pid &lt;-&gt; inode list ä¿¡æ¯ï¼Œæœ€åè®¡ç®—å‡ºæ¯ä¸ªè¿›ç¨‹çš„ç½‘ç»œæµé‡ã€‚</p>

<p>è¿™ä¹ˆç»•çš„è®¡ç®—æ–¹æ³•ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªä¸–é—´æ—©ä»¥æœ‰ç‰›äººå®ç°äº†ï¼ŒGoogleäº†ä¸€ä¸‹ï¼Œå‘ç°å¯ä»¥ç›´æ¥ä½¿ç”¨ libnethogs è¿™ä¸ªåº“æ¥è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ç½‘ç»œæµé‡ã€‚</p>

<p>å…·ä½“çš„ä»£ç å®ç°å¯ä»¥å‚è€ƒï¼šhttps://github.com/manateelazycat/deepin-system-monitor/blob/master/src/network_traffic_filter.cpp</p>

<p>nethogsè¿™ç§æ–¹å¼åªèƒ½è®¡ç®—å‡ºTCPé“¾æ¥çš„ç½‘ç»œæµé‡ï¼Œæ— æ³•è®¡ç®—UDPé“¾æ¥çš„ç½‘ç»œæµé‡ï¼Œå½“ç„¶TCPæµé‡åˆ†æå·²ç»æ»¡è¶³äº†å¤§éƒ¨åˆ†åº”ç”¨çš„éœ€æ±‚ã€‚</p>

<h4 id="wineç¨‹åºçš„ç½‘ç»œæµé‡">Wineç¨‹åºçš„ç½‘ç»œæµé‡</h4>
<p>ä¸Šé¢è¯´çš„æ–¹æ³•é€‚ç”¨äºLinuxåŸç”Ÿåº”ç”¨çš„ç½‘ç»œè¿›åŸç›‘æ§ï¼Œä½†æ˜¯æ— æ³•ç›´æ¥é€šè¿‡ç›‘å¬Wineç¨‹åºçš„ç½‘ç»œæµé‡ï¼Œæ¯”å¦‚åŸºäºWineè¿è¡Œçš„è¿…é›·ã€‚
å½“ä¸€ä¸ªWineç¨‹åºéœ€è¦è¿›è¡Œç½‘ç»œä¸Šä¼ å’Œä¸‹è½½çš„æ—¶å€™ï¼Œ Wineä¼šåå°åˆ†é…ä¸€ä¸ª wineserver.real çš„è¿›ç¨‹æ¥å®ŒæˆWineç¨‹åºç½‘ç»œä»£ç†çš„åŠŸèƒ½ï¼Œwineserver.real è·å¾—ç½‘ç»œæ•°æ®ä»¥åå†ä¼ é€’ç»™ Wine ç¨‹åºã€‚</p>

<p>æ‰€ä»¥è®¡ç®—Wineç¨‹åºçš„ç½‘ç»œæµé‡çš„æ­¥éª¤æ˜¯ï¼š
1ã€ç»Ÿè®¡æ‰€æœ‰Wineç¨‹åºè¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡ï¼Œé€šè¿‡ GIO_LAUNCHED_DESKTOP_FILE è¿™ä¸ªç¯å¢ƒå˜é‡è·å¾— Wine ç¨‹åºçš„ desktop æ–‡ä»¶è·¯å¾„ï¼›
2ã€ç»Ÿè®¡æ‰€æœ‰ wineserver.real è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ï¼Œé€šè¿‡ GIO_LAUNCHED_DESKTOP_FILE è¿™ä¸ªç¯å¢ƒå˜é‡è·å¾—wineserver.real è¿›ç¨‹ çš„ desktop æ–‡ä»¶è·¯å¾„ï¼›
3ã€åˆ†æç³»ç»Ÿçš„TCPé“¾æ¥åï¼Œæ‰¾åˆ°åŒ¹é…çš„ wineserver.real çš„pid;
4ã€é€šè¿‡ wineserver.real åŒ¹é…çš„ desktop æ–‡ä»¶æ‰¾åˆ°å¯¹åº”çš„ Wine ç¨‹åºçš„ pid;
5ã€æœ€åï¼Œç”¨ wineserver.real è¿›ç¨‹çš„ç½‘ç»œæµé‡æ•°æ®æ›¿æ¢ Wine ç¨‹åºçš„ç½‘ç»œæµé‡ï¼Œå¹¶æ¸…ç©º wineserver.real è¿›ç¨‹çš„ç½‘ç»œæµé‡ï¼›</p>

<p>è¿™æ ·ç”¨æˆ·å°±å¯ä»¥åœ¨ç³»ç»Ÿç›‘è§†å™¨çœ‹åˆ°Wineç¨‹åºçš„ç½‘ç»œæµé‡äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://localhost:4000/pics/deepin-system-monitor/deepin-system-monitor-4.png" alt="" /></p>

<p>ä»£ç å‚è€ƒå®ç°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getDesktopFileFromName</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">QString</span> <span class="n">procName</span><span class="p">,</span> <span class="n">QString</span> <span class="n">cmdline</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">desktopfileMaps</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">cmdline</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">desktopfileMaps</span><span class="p">[</span><span class="n">cmdline</span><span class="p">].</span><span class="n">toStdString</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Need found desktop file from process environment, if process is wine program.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"c:</span><span class="se">\\</span><span class="s">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">QString</span> <span class="n">gioDesktopFile</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">::</span><span class="n">getProcessEnvironmentVariable</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s">"GIO_LAUNCHED_DESKTOP_FILE"</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">gioDesktopFile</span><span class="p">.</span><span class="n">toStdString</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">QDirIterator</span> <span class="n">dir</span><span class="p">(</span><span class="s">"/usr/share/applications"</span><span class="p">,</span> <span class="n">QDirIterator</span><span class="o">::</span><span class="n">Subdirectories</span><span class="p">);</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">desktopFile</span><span class="p">;</span>

                <span class="c1">// Convert to lower characters.</span>
                <span class="n">QString</span> <span class="n">procname</span> <span class="o">=</span> <span class="n">procName</span><span class="p">.</span><span class="n">toLower</span><span class="p">();</span>

                <span class="c1">// Replace "_" instead "-", avoid some applications desktop file can't found, such as, sublime text.</span>
                <span class="n">procname</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"_"</span><span class="p">,</span> <span class="s">"-"</span><span class="p">);</span>

                <span class="c1">// Concat desktop file.</span>
                <span class="n">QString</span> <span class="n">processFilename</span> <span class="o">=</span> <span class="n">procname</span> <span class="o">+</span> <span class="s">".desktop"</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">GUI_BLACKLIST_MAP</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">procname</span><span class="p">)</span> <span class="o">==</span> <span class="n">GUI_BLACKLIST_MAP</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">while</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">fileInfo</span><span class="p">().</span><span class="n">suffix</span><span class="p">()</span> <span class="o">==</span> <span class="s">"desktop"</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">fileName</span><span class="p">().</span><span class="n">toLower</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="n">processFilename</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">desktopFile</span> <span class="o">=</span> <span class="n">dir</span><span class="p">.</span><span class="n">filePath</span><span class="p">().</span><span class="n">toStdString</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="n">dir</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="n">desktopFile</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">wineApplicationDesktopMaps</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">wineServerDesktopMaps</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">:</span><span class="n">processes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
        <span class="n">QString</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">::</span><span class="n">getProcessCmdline</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">isWineProcess</span> <span class="o">=</span> <span class="n">cmdline</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"c:</span><span class="se">\\</span><span class="s">"</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">name</span> <span class="o">=</span> <span class="n">getProcessName</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">euser</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">processCpuPercents</span><span class="p">)[</span><span class="n">pid</span><span class="p">];</span>

        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">desktopFile</span> <span class="o">=</span> <span class="n">getDesktopFileFromName</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">title</span> <span class="o">=</span> <span class="n">findWindowTitle</span><span class="o">-&gt;</span><span class="n">getWindowTitle</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>

        <span class="kt">bool</span> <span class="n">isGui</span> <span class="o">=</span> <span class="p">(</span><span class="n">title</span> <span class="o">!=</span> <span class="s">""</span><span class="p">);</span>

        <span class="c1">// Record wine application and wineserver.real desktop file.</span>
        <span class="c1">// We need transfer wineserver.real network traffic to the corresponding wine program.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">"wineserver.real"</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Insert pid&lt;-&gt;desktopFile to map to search in all network process list.</span>
            <span class="n">QString</span> <span class="n">gioDesktopFile</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">::</span><span class="n">getProcessEnvironmentVariable</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s">"GIO_LAUNCHED_DESKTOP_FILE"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gioDesktopFile</span> <span class="o">!=</span> <span class="s">""</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="o">*</span><span class="n">wineServerDesktopMaps</span><span class="p">)[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">gioDesktopFile</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Insert desktopFile&lt;-&gt;pid to map to search in all network process list.</span>
            <span class="c1">// If title is empty, it's just a wine program, but not wine GUI window.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isWineProcess</span> <span class="o">&amp;&amp;</span> <span class="n">title</span> <span class="o">!=</span> <span class="s">""</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="o">*</span><span class="n">wineApplicationDesktopMaps</span><span class="p">)[</span><span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">desktopFile</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">isGui</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">guiProcessNumber</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">systemProcessNumber</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">bool</span> <span class="n">appendItem</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filterType</span> <span class="o">==</span> <span class="n">OnlyGUI</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">appendItem</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="n">currentUsername</span> <span class="o">&amp;&amp;</span> <span class="n">isGui</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">filterType</span> <span class="o">==</span> <span class="n">OnlyMe</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">appendItem</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="n">currentUsername</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">filterType</span> <span class="o">==</span> <span class="n">AllProcess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">appendItem</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">appendItem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">title</span> <span class="o">==</span> <span class="s">""</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isWineProcess</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// If wine process's window title is blank, it's not GUI window process.</span>
                    <span class="c1">// Title use process name instead.</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">getDisplayNameFromName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">desktopFile</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">QString</span> <span class="n">displayName</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filterType</span> <span class="o">==</span> <span class="n">AllProcess</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">displayName</span> <span class="o">=</span> <span class="n">QString</span><span class="p">(</span><span class="s">"[%1] %2"</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">displayName</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">long</span> <span class="n">memory</span> <span class="o">=</span> <span class="p">((</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resident</span> <span class="o">-</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>

            <span class="n">QPixmap</span> <span class="n">icon</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">desktopFile</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">findWindowTitle</span><span class="o">-&gt;</span><span class="n">getWindowIcon</span><span class="p">(</span><span class="n">findWindowTitle</span><span class="o">-&gt;</span><span class="n">getWindow</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="mi">24</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">getDesktopFileIcon</span><span class="p">(</span><span class="n">desktopFile</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">ProcessItem</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessItem</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">displayName</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
            <span class="n">items</span> <span class="o">&lt;&lt;</span> <span class="n">item</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Fill GUI processes information for continue merge action.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filterType</span> <span class="o">==</span> <span class="n">OnlyGUI</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">childInfoMap</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
                    <span class="kt">long</span> <span class="n">memory</span> <span class="o">=</span> <span class="p">((</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resident</span> <span class="o">-</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">share</span><span class="p">)</span> <span class="o">*</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>
                    <span class="n">childInfoMap</span><span class="p">[</span><span class="n">pid</span><span class="p">].</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
                    <span class="n">childInfoMap</span><span class="p">[</span><span class="n">pid</span><span class="p">].</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Transfer wineserver.real network traffic to the corresponding wine program.</span>
    <span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">NetworkStatus</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">networkStatusSnapshot</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">networkStatusSnapshot</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wineServerDesktopMaps</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">key</span><span class="p">()))</span> <span class="p">{</span>
            <span class="n">QString</span> <span class="n">wineDesktopFile</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">wineServerDesktopMaps</span><span class="p">)[</span><span class="n">i</span><span class="p">.</span><span class="n">key</span><span class="p">()];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">wineApplicationDesktopMaps</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">wineDesktopFile</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// Transfer wineserver.real network traffic to the corresponding wine program.</span>
                <span class="kt">int</span> <span class="n">wineApplicationPid</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">wineApplicationDesktopMaps</span><span class="p">)[</span><span class="n">wineDesktopFile</span><span class="p">];</span>
                <span class="n">networkStatusSnapshot</span><span class="p">[</span><span class="n">wineApplicationPid</span><span class="p">]</span> <span class="o">=</span> <span class="n">networkStatusSnapshot</span><span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">key</span><span class="p">()];</span>

                <span class="c1">// Reset wineserver network status to zero.</span>
                <span class="n">NetworkStatus</span> <span class="n">networkStatus</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
                <span class="n">networkStatusSnapshot</span><span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">networkStatus</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h4 id="æ‰¾åˆ°è¿›ç¨‹å¯¹åº”çš„åå­—">æ‰¾åˆ°è¿›ç¨‹å¯¹åº”çš„åå­—</h4>
<p>ä¸»è¦çš„åå­—ä¸»è¦æœ‰ä¸‰ç§å½¢å¼ï¼šå›¾å½¢çª—å£çš„æ ‡é¢˜ã€Desktopæ–‡ä»¶å¯¹åº”çš„æœ¬åœ°åŒ–åç§°å’Œæœ€åçš„å‘½ä»¤è¡Œåç§°ã€‚</p>

<p>å›¾å½¢çª—å£çš„æ ‡é¢˜çš„æ­¥éª¤æ˜¯ï¼š
1ã€é€šè¿‡XCBåˆ†æ _NET_CLIENT_LIST_STACKING æ•°æ®åˆ—å‡ºæ‰€æœ‰å›¾å½¢çª—å£çš„XID
2ã€é€šè¿‡XCBåˆ†æ _NET_WM_PID å¾—å‡ºæ¯ä¸ªçª—å£å¯¹åº”çš„ pid
3ã€ç„¶åå¯¹æ¯”å›¾å½¢çª—å£çš„ pid list å’Œ process pid list, æ‰¾åˆ°æ‰€æœ‰å›¾å½¢çª—å£çš„ pid list
4ã€æœ€åé€šè¿‡XCBåˆ†æ xid å¯¹åº”çš„ _NET_WM_NAME æ¥æŸ¥æ‰¾å›¾å½¢çª—å£çš„æ ‡é¢˜</p>

<p>å…·ä½“çš„ä»£ç å®ç°å‚è€ƒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QList</span><span class="o">&lt;</span><span class="n">xcb_window_t</span><span class="o">&gt;</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">getWindows</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">QList</span><span class="o">&lt;</span><span class="n">xcb_window_t</span><span class="o">&gt;</span> <span class="n">windows</span><span class="p">;</span>
    <span class="n">xcb_get_property_reply_t</span> <span class="o">*</span><span class="n">listReply</span> <span class="o">=</span> <span class="n">getProperty</span><span class="p">(</span><span class="n">rootWindow</span><span class="p">,</span> <span class="s">"_NET_CLIENT_LIST_STACKING"</span><span class="p">,</span> <span class="n">XCB_ATOM_WINDOW</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listReply</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xcb_window_t</span> <span class="o">*</span><span class="n">windowList</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">xcb_window_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xcb_get_property_value</span><span class="p">(</span><span class="n">listReply</span><span class="p">));</span>
        <span class="kt">int</span> <span class="n">windowListLength</span> <span class="o">=</span> <span class="n">listReply</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">windowListLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">xcb_window_t</span> <span class="n">window</span> <span class="o">=</span> <span class="n">windowList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

            <span class="n">foreach</span><span class="p">(</span><span class="n">QString</span> <span class="n">type</span><span class="p">,</span> <span class="n">getWindowTypes</span><span class="p">(</span><span class="n">window</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">"_NET_WM_WINDOW_TYPE_NORMAL"</span> <span class="o">||</span>
                    <span class="n">type</span> <span class="o">==</span> <span class="s">"_NET_WM_WINDOW_TYPE_DIALOG"</span>
                    <span class="p">)</span> <span class="p">{</span>
                    <span class="kt">bool</span> <span class="n">needAppend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

                    <span class="n">QStringList</span> <span class="n">states</span> <span class="o">=</span> <span class="n">getWindowStates</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">states</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
                        <span class="p">(</span><span class="o">!</span><span class="n">states</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">"_NET_WM_STATE_HIDDEN"</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">getWindowWorkspace</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="n">getCurrentWorkspace</span><span class="p">(</span><span class="n">rootWindow</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">needAppend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">needAppend</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">windows</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">free</span><span class="p">(</span><span class="n">listReply</span><span class="p">);</span>

        <span class="c1">// We need re-sort windows list from up to bottom,</span>
        <span class="c1">// to make compare cursor with window area from up to bottom.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">reverse</span><span class="p">(</span><span class="n">windows</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">windows</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

        <span class="c1">// Add desktop window.</span>
        <span class="n">windows</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rootWindow</span><span class="p">);</span>

        <span class="c1">// Just use for debug.</span>
        <span class="c1">// foreach (auto window, windows) {</span>
        <span class="c1">//     qDebug() &lt;&lt; getWindowName(window);</span>
        <span class="c1">// }</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">windows</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">getWindowPid</span><span class="p">(</span><span class="n">xcb_window_t</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">xcb_get_property_reply_t</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="n">getProperty</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="s">"_NET_WM_PID"</span><span class="p">,</span> <span class="n">XCB_ATOM_CARDINAL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">xcb_get_property_value</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>

        <span class="n">free</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">QString</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">getWindowName</span><span class="p">(</span><span class="n">xcb_window_t</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">==</span> <span class="n">rootWindow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">tr</span><span class="p">(</span><span class="s">"Desktop"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">xcb_get_property_reply_t</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="n">getProperty</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="s">"_NET_WM_NAME"</span><span class="p">,</span> <span class="n">getAtom</span><span class="p">(</span><span class="s">"UTF8_STRING"</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">QString</span> <span class="n">result</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromUtf8</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">xcb_get_property_value</span><span class="p">(</span><span class="n">reply</span><span class="p">)),</span> <span class="n">xcb_get_property_value_length</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>

            <span class="n">free</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">QString</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¾—åˆ°Desktopå¯¹åº”çš„åç§°åŸç†ï¼š
1ã€é€šè¿‡è¯»å– /proc/pid/cmdline å¾—åˆ°è¿›ç¨‹å¯¹åº”çš„å¯åŠ¨å‘½ä»¤è¡Œ
2ã€æå– cmdline ç¬¬ä¸€ä¸ªå‚æ•°å¾—åˆ°å¯åŠ¨å‘½ä»¤
3ã€é€šè¿‡å¯åŠ¨å‘½ä»¤åœ¨ /usr/share/applications ç›®å½•ä¸‹æŸ¥æ‰¾å¯¹åº”çš„ *.desktop æ–‡ä»¶
4ã€åˆ†ææ–‡ä»¶çš„ Name[locale] å­—ç¬¦ä¸²ï¼Œå¾—åˆ°æœ¬åœ°åŒ–çš„åå­—ï¼Œ locale åœ¨ä¸­æ–‡è¡¨ç¤º zh_CN</p>

<p>å…·ä½“çš„ä»£ç å®ç°å‚è€ƒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QString</span> <span class="nf">getProcessCmdline</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">temp</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">fstream</span> <span class="n">fs</span><span class="p">;</span>
            <span class="n">fs</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"/proc/"</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pid</span><span class="p">)</span><span class="o">+</span><span class="s">"/cmdline"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">fstream</span><span class="o">::</span><span class="n">in</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
            <span class="n">fs</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="o">::</span><span class="n">failure</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">"FAILED TO READ PROC"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// change \0 to ' '</span>
        <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">temp</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="sc">'\0'</span><span class="p">,</span><span class="sc">' '</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">temp</span><span class="p">).</span><span class="n">trimmed</span><span class="p">();</span>
    <span class="p">}</span>

<span class="n">QString</span> <span class="nf">getProcessNameFromCmdLine</span><span class="p">(</span><span class="k">const</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">getProcessCmdline</span><span class="p">(</span><span class="n">pid</span><span class="p">).</span><span class="n">toStdString</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Maintain linux paths.</span>
        <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">cmdline</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">cmdline</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="sc">'\\'</span><span class="p">,</span><span class="sc">'/'</span><span class="p">);</span>

        <span class="c1">// Get cmdline arguments and first argument name.</span>
        <span class="k">auto</span> <span class="n">args</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">name</span> <span class="o">=</span> <span class="n">QFileInfo</span><span class="p">(</span><span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])).</span><span class="n">fileName</span><span class="p">();</span>

        <span class="c1">// Get first argument that start with '/' if first argument is script program, such as 'python'.</span>
        <span class="k">auto</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">SCRIPT_PROGRAM_MAP</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">SCRIPT_PROGRAM_MAP</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">QString</span> <span class="n">argument</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

                <span class="c1">// Return first argument that start with '/'.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">argument</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"/"</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">QFileInfo</span><span class="p">(</span><span class="n">argument</span><span class="p">).</span><span class="n">fileName</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">QString</span> <span class="n">argument</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

                <span class="c1">// Return first argument that not start with '-'.</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argument</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"-"</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">QFileInfo</span><span class="p">(</span><span class="n">argument</span><span class="p">).</span><span class="n">fileName</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

<span class="n">QString</span> <span class="nf">getDisplayNameFromName</span><span class="p">(</span><span class="n">QString</span> <span class="n">procName</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">desktopFile</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">displayProcessName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">QString</span> <span class="n">procname</span> <span class="o">=</span> <span class="n">procName</span><span class="p">.</span><span class="n">toLower</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">processDescriptions</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">procname</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">displayProcessName</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">QString</span><span class="p">(</span><span class="s">"%1    ( %2 )"</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">processDescriptions</span><span class="p">[</span><span class="n">procname</span><span class="p">],</span> <span class="n">procName</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">processDescriptions</span><span class="p">[</span><span class="n">procname</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">desktopFile</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">procName</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">in</span><span class="p">;</span>
        <span class="n">in</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">desktopFile</span><span class="p">);</span>
        <span class="n">QString</span> <span class="n">displayName</span> <span class="o">=</span> <span class="n">procName</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">.</span><span class="n">eof</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="n">line</span><span class="p">);</span>

            <span class="n">QString</span> <span class="n">lineContent</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

            <span class="n">QString</span> <span class="n">localNameFlag</span> <span class="o">=</span> <span class="n">QString</span><span class="p">(</span><span class="s">"Name[%1]="</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">QLocale</span><span class="o">::</span><span class="n">system</span><span class="p">().</span><span class="n">name</span><span class="p">());</span>
            <span class="n">QString</span> <span class="n">nameFlag</span> <span class="o">=</span> <span class="s">"Name="</span><span class="p">;</span>
            <span class="n">QString</span> <span class="n">genericNameFlag</span> <span class="o">=</span> <span class="n">QString</span><span class="p">(</span><span class="s">"GenericName[%1]="</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">QLocale</span><span class="o">::</span><span class="n">system</span><span class="p">().</span><span class="n">name</span><span class="p">());</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">lineContent</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">localNameFlag</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">displayName</span> <span class="o">=</span> <span class="n">lineContent</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">localNameFlag</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lineContent</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">genericNameFlag</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">displayName</span> <span class="o">=</span> <span class="n">lineContent</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">genericNameFlag</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lineContent</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">nameFlag</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">displayName</span> <span class="o">=</span> <span class="n">lineContent</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nameFlag</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">in</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">displayName</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ç¬¬ä¸‰ç§è¿›ç¨‹åçš„æ–¹å¼å·²ç»åœ¨å‡½æ•° getProcessNameFromCmdLine çš„ä»£ç å®ç°ä¸­ä½“ç°äº†ã€‚</p>

<h4 id="æ‰¾åˆ°è¿›ç¨‹äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ä½ç½®">æ‰¾åˆ°è¿›ç¨‹äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ä½ç½®</h4>
<p>è¿›ç¨‹ç®¡ç†ä¸­é™¤äº†æŸ¥çœ‹è¿›ç¨‹çš„çŠ¶æ€ï¼Œå¯¹è¿›ç¨‹è¿›è¡Œç®€å•çš„ç»“æŸ/æš‚åœç®¡ç†æ“ä½œä»¥å¤–ï¼Œæœ€é‡è¦çš„é™„åŠ åŠŸèƒ½å°±æ˜¯ï¼Œæˆ‘ä»¬è¦çŸ¥é“è¿™ä¸ªè½¯ä»¶åˆ°åº•æ˜¯å“ªä¸ªå‘½ä»¤å¯åŠ¨çš„ï¼Œè¿™ä¸ªå‘½ä»¤æ‰€åœ¨çš„ç›®å½•ï¼Œè¿™æ ·å¯¹äºæˆ‘ä»¬å½»åº•äº†è§£è¿›ç¨‹èƒŒåçš„è½¯ä»¶éå¸¸æœ‰å¸®åŠ©ã€‚</p>

<p>æ·±åº¦ç³»ç»Ÿç›‘è§†å™¨å®ç°äº†ä¸€ä¸ª â€æŸ¥æ‰¾å‘½ä»¤æ‰€åœ¨ä½ç½®â€œ çš„å³é”®åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½çš„å®ç°åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š
1ã€LinuxåŸç”Ÿåº”ç”¨è¿›ç¨‹
2ã€Wineè¿›ç¨‹</p>

<p>LinuxåŸç”Ÿåº”ç”¨è¿›ç¨‹æŸ¥æ‰¾äºŒè¿›åˆ¶çš„æ­¥éª¤ï¼š
1ã€è¯»å– /proc/pid/cmdline å¾—åˆ°å‘½ä»¤è¡Œå‚æ•°
2ã€è·å– cmdline ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³å‘½ä»¤è¡Œè·¯å¾„
3ã€é€šè¿‡ which å‘½ä»¤æ¥æŸ¥è¯¢å‘½ä»¤è¡Œçš„ç»å¯¹è·¯å¾„</p>

<p>Wineè¿›ç¨‹æŸ¥æ‰¾äºŒè¿›åˆ¶çš„æ­¥éª¤ï¼š
1ã€è¯»å– /proc/pid/cmdline å¾—åˆ°å‘½ä»¤è¡Œå‚æ•°ï¼Œä¸€èˆ¬æ˜¯ c:\xxxxxxx\xxxx.exe çš„Windowsè·¯å¾„
2ã€è½¬æ¢ Windows è·¯å¾„ä¸ºï¼š drive_c/xxxxxxx/xxx.exe çš„Linuxç›¸å¯¹è·¯å¾„
3ã€é€šè¿‡è¯»å– /proc/pid/environ è·¯å¾„ï¼Œæ‰¾åˆ°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
4ã€è¿›ä¸€æ­¥æ‰¾åˆ° WINEPREFIX å¯¹åº”çš„å€¼ï¼Œä¸€èˆ¬æ˜¯ ~/.deepinwine/xxx çš„è½¯ä»¶å®‰è£…ç›®å½•å½¢å¼
5ã€æœ€åé“¾æ¥è½¯ä»¶å®‰è£…ç›®å½•+ç›¸å¯¹è·¯å¾„çš„å½¢å¼ï¼Œå¾—åˆ°Wineè¿›ç¨‹å¯åŠ¨å‘½ä»¤çš„ç»å¯¹è·¯å¾„ï¼Œä¸€èˆ¬æ˜¯ ~/.deepinwine/xxx/drive_c/xxx/xxx.exeçš„å½¢å¼</p>

<p>å…·ä½“ä»£ç å‚è€ƒå®ç°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">ProcessManager</span><span class="o">::</span><span class="n">openProcessDirectory</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">pid</span> <span class="o">:</span> <span class="o">*</span><span class="n">actionPids</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QString</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">::</span><span class="n">getProcessCmdline</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Found wine program location if cmdline starts with c://.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"c:</span><span class="se">\\</span><span class="s">"</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">QString</span> <span class="n">winePrefix</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">::</span><span class="n">getProcessEnvironmentVariable</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s">"WINEPREFIX"</span><span class="p">);</span>
                <span class="n">cmdline</span> <span class="o">=</span> <span class="n">cmdline</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">,</span> <span class="s">"/"</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">"c:/"</span><span class="p">,</span> <span class="s">"/drive_c/"</span><span class="p">);</span>

                <span class="n">DDesktopServices</span><span class="o">::</span><span class="n">showFileItem</span><span class="p">(</span><span class="n">winePrefix</span> <span class="o">+</span> <span class="n">cmdline</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Else find program location through 'which' command.</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">cmdline</span> <span class="o">=</span> <span class="n">cmdline</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">QRegExp</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">s"</span><span class="p">)).</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

                <span class="n">QProcess</span> <span class="n">whichProcess</span><span class="p">;</span>
                <span class="n">QString</span> <span class="n">exec</span> <span class="o">=</span> <span class="s">"which"</span><span class="p">;</span>
                <span class="n">QStringList</span> <span class="n">params</span><span class="p">;</span>
                <span class="n">params</span> <span class="o">&lt;&lt;</span> <span class="n">cmdline</span><span class="p">;</span>
                <span class="n">whichProcess</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
                <span class="n">whichProcess</span><span class="p">.</span><span class="n">waitForFinished</span><span class="p">();</span>
                <span class="n">QString</span> <span class="n">output</span><span class="p">(</span><span class="n">whichProcess</span><span class="p">.</span><span class="n">readAllStandardOutput</span><span class="p">());</span>

                <span class="n">QString</span> <span class="n">processPath</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">DDesktopServices</span><span class="o">::</span><span class="n">showFileItem</span><span class="p">(</span><span class="n">processPath</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">actionPids</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">QString</span> <span class="n">getProcessEnvironmentVariable</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="n">QString</span> <span class="n">environmentName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">temp</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">fstream</span> <span class="n">fs</span><span class="p">;</span>
            <span class="n">fs</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"/proc/"</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pid</span><span class="p">)</span><span class="o">+</span><span class="s">"/environ"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">fstream</span><span class="o">::</span><span class="n">in</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="n">temp</span><span class="p">);</span>
            <span class="n">fs</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="o">::</span><span class="n">failure</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">"FAILED TO READ PROC"</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// change \0 to ' '</span>
        <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">temp</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="sc">'\0'</span><span class="p">,</span><span class="sc">'\n'</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">foreach</span> <span class="p">(</span><span class="k">auto</span> <span class="n">environmentVariable</span><span class="p">,</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">temp</span><span class="p">).</span><span class="n">trimmed</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">environmentVariable</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="n">environmentName</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">environmentVariable</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QString</span><span class="p">(</span><span class="s">"%1="</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">environmentName</span><span class="p">).</span><span class="n">length</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h4 id="ç”¨setcapæ›¿æ¢setuidçš„æ–¹å¼ç»™äºˆè¯»å–ç³»ç»Ÿç›®å½•çš„æƒé™">ç”¨setcapæ›¿æ¢setuidçš„æ–¹å¼ç»™äºˆè¯»å–ç³»ç»Ÿç›®å½•çš„æƒé™</h4>
<p>ä¸Šé¢è®²è§£äº†æ·±åº¦ç³»ç»Ÿç›‘è§†å™¨çš„æ ¸å¿ƒæ¨¡å—çš„åŸç†å’Œä»£ç å‚è€ƒå®ç°ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¤§éƒ¨åˆ†éƒ½è¦è¯»å–ç³»ç»Ÿç›®å½• /proc, /procè¿™ä¸ªç›®å½•çš„å¤§éƒ¨åˆ†å†…å®¹åªæœ‰rootç”¨æˆ·æ‰æœ‰æƒé™è¯»å–ã€‚</p>

<p>å¾ˆå¤šåˆå­¦è€…å–œæ¬¢ç”¨setuidçš„æ–¹å¼ç›´æ¥èµ‹äºˆäºŒè¿›åˆ¶rootæƒé™ï¼Œä½†æ˜¯è¿™æ ·éå¸¸å±é™©ï¼Œä¼šé€ æˆå›¾å½¢å‰ç«¯è·å¾—è¿‡å¤§çš„æƒé™ï¼Œä»è€Œäº§ç”Ÿå®‰å…¨æ¼æ´ã€‚</p>

<p>Linuxå†…æ ¸é’ˆå¯¹è¿™ç§æƒ…å†µæœ‰æ›´å¥½çš„å®ç°æ–¹å¼ï¼Œç”¨ setcap ç»™äºˆäºŒè¿›åˆ¶ç‰¹å®šçš„æƒé™ï¼Œä¿è¯äºŒè¿›åˆ¶çš„ç‰¹æ®Šæƒé™åœ¨æœ€å°çš„èŒƒå›´ä¸­ï¼Œæ¯”å¦‚åœ¨æ·±åº¦ç³»ç»Ÿç›‘è§†å™¨ä¸­å°±ç”¨å‘½ä»¤ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>setcap cap_kill,cap_net_raw,cap_dac_read_search,cap_sys_ptrace+ep ./deepin-system-monitor
</code></pre></div></div>

<p>æ¥ç»™äºˆè¿›ç¨‹ç›¸åº”çš„èƒ½åŠ›ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
  <li>cap_net_raw å¯¹åº”ç½‘ç»œæ–‡ä»¶è¯»å–æƒé™</li>
  <li>cap_dac_read_search å¯¹åº”æ–‡ä»¶è¯»å–æ£€æŸ¥æƒé™</li>
  <li>cap_sys_ptrace å¯¹åº”è¿›ç¨‹å†…å­˜ä¿¡æ¯è¯»å–æƒé™
è¿™æ ·ï¼Œåœ¨ä¿è¯äºŒè¿›åˆ¶æœ‰å¯¹åº”è¯»å–æƒé™çš„åŒæ—¶ï¼Œåˆä¿è¯äº†äºŒè¿›åˆ¶æœ€å°åŒ–çš„æƒé™èŒƒå›´ï¼Œæœ€å¤§åŒ–çš„ä¿è¯äº†åº”ç”¨å’Œç³»ç»Ÿçš„å®‰å…¨ã€‚</li>
</ul>

<p>æœ€åï¼Œæ·±åº¦ç³»ç»Ÿç›‘è§†å™¨æ•´ä¸ªé¡¹ç›®éƒ½éµå®ˆGPLv3è®¸å¯è¯åè®®ï¼Œæ¬¢è¿å„ä½å¤§ç¥è´¡çŒ®ä»£ç ï¼š <a href="https://github.com/manateelazycat/deepin-system-monitor">Github</a></p>
:ET