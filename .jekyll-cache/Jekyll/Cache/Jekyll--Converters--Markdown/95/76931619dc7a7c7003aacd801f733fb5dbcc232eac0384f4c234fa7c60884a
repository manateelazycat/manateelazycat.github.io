I"¸T<h3 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h3>
<p>å¼€å‘åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹æœ¬è´¨å°±æ˜¯é€šè¿‡å›¾å½¢åº“è·å¾—ç”¨æˆ·çš„è¾“å…¥äº‹ä»¶ï¼ˆé¼ æ ‡ã€é”®ç›˜æˆ–è€…è§¦æ‘¸å±ç­‰ï¼‰å’Œæ•°æ®ä»¥åï¼Œå¯¹è¿™äº›ç”¨æˆ·çš„äº‹ä»¶å’Œæ•°æ®è¿›è¡Œå¤„ç†åï¼Œé€šè¿‡ç•Œé¢æˆ–å…¶ä»–äº¤äº’å½¢å¼å±•ç°ç»™ç”¨æˆ·ç»“æœã€‚</p>

<p>åº”ç”¨ç¨‹åºå®Œæˆåï¼Œæ‹¥æœ‰ç¾è§‚çš„ç•Œé¢å’Œç®€æ´æ˜“ç”¨çš„ä½¿ç”¨é€»è¾‘ï¼Œè®©ç”¨æˆ·åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ„Ÿåˆ°èˆ’æœå’Œçˆ½å¿«ï¼Œè¿™æ ·çš„åº”ç”¨ç¨‹åºæˆ‘ä»¬å°±å¯ä»¥ç§°ä¸ºäº¤äº’ä½“éªŒä¼˜ç§€çš„äº§å“ã€‚</p>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨ç¨‹åºçª—å£çš„æ‰€æœ‰äº‹ä»¶éƒ½å¯ä»¥é€šè¿‡å›¾å½¢åº“(Gtk+ã€Qtç­‰ï¼‰è‡ªå·±æ¥è·å–çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ç§æŠ€æœ¯æ¥è·å–æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„äº‹ä»¶ï¼Œæ¥æ»¡è¶³ä»¥ä¸‹åœºæ™¯ï¼š</p>
<ul>
  <li>ç›‘å¬ç”¨æˆ·è¾“å…¥çš„é¼ æ ‡äº‹ä»¶ï¼Œæ¯”å¦‚å±å¹•å–è¯</li>
  <li>ç›‘å¬ç”¨æˆ·è¾“å…¥çš„é”®ç›˜äº‹ä»¶ï¼Œæ¯”å¦‚å…¨å±€å¿«æ·é”®</li>
</ul>

<p>è¿™æ—¶å€™Gtkï¼‹å’ŒQtå°±æ— æ³•åšåˆ°ï¼Œéœ€è¦X11ç›¸å…³çš„æŠ€æœ¯æ‰èƒ½åšåˆ°å¯¹ç³»ç»Ÿçš„äº‹ä»¶è¿›è¡Œç›‘å¬ã€‚
X11ç›¸å…³çš„æŠ€æœ¯æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ul>
  <li>é€šè¿‡ <a href="https://tronche.com/gui/x/xlib/input/XGrabPointer.html">XGrabPointer</a> å’Œ <a href="https://tronche.com/gui/x/xlib/input/XGrabKeyboard.html">XGrabKeyboard</a> æŠ“å–ç³»ç»Ÿçš„ç„¦ç‚¹åç›‘å¬å…¨å±€äº‹ä»¶</li>
  <li>é€šè¿‡ <a href="https://www.x.org/releases/X11R7.6/doc/libXtst/recordlib.html">XRecord Extension</a> éä¾µå…¥å¼çš„ç›‘å¬å…¨å±€äº‹ä»¶</li>
</ul>

<p>XGrabPointer å’Œ XGrabKeyboard ä¸€èˆ¬ä¸»è¦ç”¨äºèœå•çš„å®ç°ï¼Œè€Œä¸”è¿™ç§æ–¹æ³•å¿…é¡»è¦æŠ¢å ç”¨æˆ·çš„é¼ æ ‡æˆ–é”®ç›˜ç„¦ç‚¹ï¼Œå¯¼è‡´ä¸€æ—¦ç„¦ç‚¹è¢«æŠ¢å æ—¶ï¼Œåˆ«çš„ç¨‹åºå°±æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆæ¯”å¦‚èœå•å¼¹å‡ºæ—¶ï¼Œå…¶ä»–ç¨‹åºå°±æ— æ³•è¾“å…¥å­—ç¬¦æˆ–å“åº”é¼ æ ‡äº‹ä»¶äº†ï¼‰ã€‚</p>

<p>å¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºç›‘å¬äº‹ä»¶æ—¶å¾€å¾€å¹¶ä¸éœ€è¦æŠ¢å ç³»ç»Ÿçš„äº‹ä»¶ç„¦ç‚¹ï¼Œå¸Œæœ›åœ¨ç›‘å¬äº‹ä»¶çš„æ—¶å€™ç”¨æˆ·å¯ä»¥æ­£å¸¸æ“ä½œç³»ç»Ÿã€‚æ‰€ä»¥ï¼Œä»Šå¤©è®²è§£ä¸€ä¸‹æ€ä¹ˆç”¨ XRecord è¿™ä¸ªX11çš„æ‰©å±•åº“æ¥è¿›è¡Œé¼ æ ‡äº‹ä»¶ä»¥åŠé”®ç›˜äº‹ä»¶çš„ç›‘å¬ã€‚</p>

<h3 id="æŠ€æœ¯åŸç†">æŠ€æœ¯åŸç†</h3>
<p>X11æ˜¯Linuxä¸‹æœ€å¤è€å’Œé€šç”¨çš„æŠ€æœ¯ï¼Œä¸è®ºç”¨æˆ·çš„è¾“å…¥äº‹ä»¶è¿˜æ˜¯æœ€åç”»åˆ°å±å¹•çš„ç»˜åˆ¶åŠ¨ä½œå…¶å®éƒ½æ˜¯ XServer æ¥å®ç°çš„ã€‚</p>

<p>Linuxä¸‹æ‰€æœ‰å›¾å½¢åº”ç”¨çš„åº•å±‚æ¶ˆæ¯é¡ºåºéƒ½æ˜¯æŒ‰ç…§ä¸‹é¢çš„é¡ºåºæ¥æ‰§è¡Œçš„ï¼š
ç¡¬ä»¶äº§ç”Ÿäº‹ä»¶â†’XServerå‘é€è¾“å…¥äº‹ä»¶ç»™å›¾å½¢åº“â†’å›¾å½¢åº“(X Client)åŒ…è£…è¾“å…¥äº‹ä»¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºâ†’åº”ç”¨æ ¹æ®è¾“å…¥äº‹ä»¶äº§ç”Ÿç»˜åˆ¶å‘½ä»¤â†’å›¾å½¢åº“ï¼ˆX Client)æ ¹æ®åº”ç”¨ç»˜åˆ¶å‘½ä»¤äº§ç”Ÿç»˜åˆ¶æ¶ˆæ¯â†’XServeræ¥å—ç»˜åˆ¶æ¶ˆæ¯â†’ç»˜åˆ¶å›¾å½¢åˆ°å±å¹•ä¸Šã€‚</p>

<p>ä¸Šé¢é¡ºåºä¸­çš„ X Client å°±æ˜¯æˆ‘ä»¬é€šå¸¸è¯´çš„ Gtk+ã€Qtè¿™äº›å›¾å½¢åº“ï¼Œé€šè¿‡ xcb/xlib å’Œ XServer è¿›è¡Œè¾“å…¥è¾“å‡ºé€šè®¯ï¼Œä¿è¯è¾“å…¥äº‹ä»¶å’Œè¾“å‡ºç»˜åˆ¶éƒ½å¯ä»¥åŠæ—¶å“åº”ï¼ŒåŒæ—¶å›¾å½¢å¼€å‘åº“æä¾›é«˜çº§çš„APIå°è£…ï¼Œè®©å¼€å‘çš„åŒå­¦ä¸ç”¨ç›´æ¥ç¼–å†™å¤æ‚çš„Xcb/Xlib é€šè®¯ä»£ç å’Œå‚æ•°ç»†èŠ‚ã€‚</p>

<p>è€Œ XRecord å°±æ˜¯ä¸€ä¸ª XServer ç«¯çš„æ‰©å±•ï¼Œä½ å¯ä»¥æƒ³è±¡ XRecord å°±åƒä¸€æ¡å¯„ç”Ÿè™«å¯„ç”Ÿåˆ° XServer é‡Œé¢ï¼Œåªè¦ XServer ä»ç¡¬ä»¶é‚£é‡Œæ¥æ”¶åˆ°æ‰€æœ‰è¾“å…¥äº‹ä»¶éƒ½ä¼šå‘Šè¯‰ä¸€ä¸‹ XRecord, æˆ‘ä»¬åªéœ€æŠŠå¯¹åº”çš„ä»£ç æŒ‚åˆ° XRecord å¾ªç¯ä¸­ï¼Œåªæœ‰ç³»ç»Ÿä¸€æœ‰è¾“å…¥äº‹ä»¶äº§ç”Ÿï¼ŒXServerå°±ä¼šå‘Šè¯‰XRecord, XRecordæ¥ç€å°±é€šè¿‡äº‹ä»¶å¾ªç¯å‘Šè¯‰æˆ‘ä»¬å†™çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå†åˆ©ç”¨å®æ—¶æˆªè·åˆ°çš„è¾“å…¥äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p>

<p>è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿçš„æ‚„æ— å£°æ¯ï¼Œæ—¢ç›‘å¬äº†ç³»ç»Ÿä¸Šæ‰€æœ‰çš„è¾“å…¥äº‹ä»¶åˆä¸ä¼šå½±å“ç³»ç»Ÿä¸­çš„ä»»ä½•åº”ç”¨ï¼Œæ˜¯ä¸æ˜¯å¬ç€å¾ˆé‚ªæ¶ï¼Ÿï¼ˆåˆ€èƒ½åˆ‡èœä¹Ÿèƒ½ä¼¤å®³åˆ«äººï¼Œåƒä¸‡ä¸è¦åšåäº‹å“Ÿï¼‰</p>

<h3 id="ä»£ç è®²è§£">ä»£ç è®²è§£</h3>
<p>è¾“å…¥äº‹ä»¶ç›‘å¬çš„æ ¸å¿ƒä»£ç éƒ½åœ¨ <a href="https://github.com/WHLUG/xrecord-example/blob/master/src/event_monitor.cpp">event_monitor.cpp</a> ä¸­ï¼Œä¸‹é¢æˆ‘ä¸€ä¸ªä¸€ä¸ªå‡½æ•°çš„è®²è§£ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å› ä¸º XRecord çš„äº‹ä»¶å¾ªç¯ä¼šå µå¡å½“å‰çº¿ç¨‹ï¼Œé¿å…ç›‘å¬äº‹ä»¶çš„æ—¶å€™åº”ç”¨ç¨‹åºå¡ä¸»</span>
<span class="c1">// æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªç»§æ‰¿äº QThread çš„EventMonitorç±»ï¼Œé€šè¿‡å­çº¿ç¨‹è¿›è¡Œäº‹ä»¶ç›‘å¬æ“ä½œ</span>
<span class="n">EventMonitor</span><span class="o">::</span><span class="n">EventMonitor</span><span class="p">(</span><span class="n">QObject</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="n">QThread</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
<span class="err">ã€€</span><span class="c1">// é¼ æ ‡æŒ‰ä¸‹æ ‡å¿—ä½ï¼Œç”¨äºè¯†åˆ«é¼ æ ‡çš„æ‹–æ‹½æ“ä½œ</span>
    <span class="n">isPress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">EventMonitor</span><span class="o">::</span><span class="n">run</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// åˆ›å»ºè®°å½• XRecord åè®®çš„ X ä¸“ç”¨è¿æ¥</span>
    <span class="n">Display</span><span class="o">*</span> <span class="n">display</span> <span class="o">=</span> <span class="n">XOpenDisplay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// è¿æ¥æ‰“å¼€æ£€æŸ¥</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"unable to open display</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åˆå§‹åŒ– XRecordCreateContext æ‰€éœ€çš„ XRecordClientSpec å‚æ•°</span>
    <span class="c1">// XRecordAllClients çš„æ„æ€æ˜¯ "è®°å½•æ‰€æœ‰ X Client" çš„äº‹ä»¶</span>
    <span class="n">XRecordClientSpec</span> <span class="n">clients</span> <span class="o">=</span> <span class="n">XRecordAllClients</span><span class="p">;</span>

    <span class="c1">// åˆ›å»º XRecordRange å˜é‡ï¼ŒXRecordRange ç”¨äºæ§åˆ¶è®°å½•äº‹ä»¶çš„èŒƒå›´</span>
    <span class="n">XRecordRange</span><span class="o">*</span> <span class="n">range</span> <span class="o">=</span> <span class="n">XRecordAllocRange</span><span class="p">();</span>

    <span class="c1">// è®°å½•äº‹ä»¶èŒƒå›´æ£€æŸ¥</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"unable to allocate XRecordRange</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åˆå§‹åŒ–è®°å½•äº‹ä»¶èŒƒå›´ï¼ŒèŒƒå›´å¼€å¤´è®¾ç½®æˆ KeyPress, èŒƒå›´ç»“å°¾è®¾ç½®æˆ MotionNotify å</span>
    <span class="c1">// äº‹ä»¶çš„ç±»å‹å°±åŒ…æ‹¬ KeyPressã€KeyRelaseã€ButtonPressã€ButtonReleaseã€MotionNotifyäº”ç§äº‹ä»¶</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">XRecordRange</span><span class="p">));</span>
    <span class="n">range</span><span class="o">-&gt;</span><span class="n">device_events</span><span class="p">.</span><span class="n">first</span> <span class="o">=</span> <span class="n">KeyPress</span><span class="p">;</span>
    <span class="n">range</span><span class="o">-&gt;</span><span class="n">device_events</span><span class="p">.</span><span class="n">last</span>  <span class="o">=</span> <span class="n">MotionNotify</span><span class="p">;</span>

    <span class="c1">// æ ¹æ®ä¸Šé¢çš„è®°å½•å®¢æˆ·ç«¯ç±»å‹å’Œè®°å½•äº‹ä»¶èŒƒå›´æ¥åˆ›å»ºã€€â€œè®°å½•ä¸Šä¸‹æ–‡â€</span>
    <span class="c1">// ç„¶åæŠŠ XRecordContext ä¼ é€’ç»™ XRecordEnableContext å‡½æ•°æ¥å¼€å¯äº‹ä»¶è®°å½•å¾ªç¯</span>
    <span class="n">XRecordContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">XRecordCreateContext</span> <span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clients</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"XRecordCreateContext failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// é‡Šæ”¾ range æŒ‡é’ˆ</span>
    <span class="n">XFree</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>

    <span class="c1">// XSync çš„ä½œç”¨å°±æ˜¯æŠŠä¸Šé¢çš„ X ä»£ç ç«‹å³å‘ç»™ X Server</span>
    <span class="c1">// è¿™æ · X Server æ¥å—åˆ°äº‹ä»¶ä»¥åä¼šç«‹å³å‘é€ç»™ XRecord çš„ Client è¿æ¥</span>
    <span class="n">XSync</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">True</span><span class="p">);</span>

    <span class="c1">// å»ºç«‹ä¸€ä¸ªä¸“é—¨è¯»å– XRecord åè®®æ•°æ®çš„ X é“¾æ¥</span>
    <span class="n">Display</span><span class="o">*</span> <span class="n">display_datalink</span> <span class="o">=</span> <span class="n">XOpenDisplay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// è¿æ¥æ‰“å¼€æ£€æŸ¥</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">display_datalink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"unable to open second display</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// è°ƒç”¨ XRecordEnableContext å‡½æ•°å»ºç«‹ XRecord ä¸Šä¸‹æ–‡</span>
    <span class="c1">// XRecordEnableContext å‡½æ•°ä¸€æ—¦è°ƒç”¨å°±å¼€å§‹è¿›å…¥å µå¡æ—¶çš„äº‹ä»¶å¾ªç¯ï¼Œç›´åˆ°çº¿ç¨‹æˆ–æ‰€å±è¿›ç¨‹ç»“æŸ</span>
    <span class="c1">// X Server äº‹ä»¶ä¸€æ—¦å‘ç”Ÿå°±ä¼ é€’ç»™äº‹ä»¶å¤„ç†å›è°ƒå‡½æ•°</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XRecordEnableContext</span><span class="p">(</span><span class="n">display_datalink</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>  <span class="n">callback</span><span class="p">,</span> <span class="p">(</span><span class="n">XPointer</span><span class="p">)</span> <span class="k">this</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"XRecordEnableContext() failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// handleRecordEvent å‡½æ•°çš„wrapperï¼Œé¿å… XRecord ä»£ç ç¼–è¯‘ä¸è¿‡çš„é—®é¢˜</span>
<span class="kt">void</span> <span class="n">EventMonitor</span><span class="o">::</span><span class="n">callback</span><span class="p">(</span><span class="n">XPointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">XRecordInterceptData</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">((</span><span class="n">EventMonitor</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">handleRecordEvent</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// çœŸå®å¤„ç† X äº‹ä»¶ç›‘å¬çš„å›è°ƒå‡½æ•°</span>
<span class="kt">void</span> <span class="n">EventMonitor</span><span class="o">::</span><span class="n">handleRecordEvent</span><span class="p">(</span><span class="n">XRecordInterceptData</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">==</span> <span class="n">XRecordFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¾—åˆ° xEvent å¯¹è±¡</span>
        <span class="n">xEvent</span> <span class="o">*</span> <span class="n">event</span> <span class="o">=</span> <span class="p">(</span><span class="n">xEvent</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ButtonPress</span><span class="p">:</span>
            <span class="c1">// è¿‡æ»¤æ‰æ»šè½®äº‹ä»¶åï¼Œå‘é€ buttonPress ä¿¡å·</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filterWheelEvent</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">detail</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">isPress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">emit</span> <span class="n">buttonPress</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootX</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootY</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">MotionNotify</span><span class="p">:</span>
            <span class="c1">// åªæœ‰åœ¨æŒ‰ä¸‹é¼ æ ‡çš„æ—¶å€™ç§»åŠ¨ï¼Œæ‰å‘é€ buttonDrag ä¿¡å·</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isPress</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">emit</span> <span class="n">buttonDrag</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootX</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootY</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">ButtonRelease</span><span class="p">:</span>
            <span class="c1">// è¿‡æ»¤æ‰æ»šè½®äº‹ä»¶åï¼Œå‘é€ buttonRelase ä¿¡å·</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">filterWheelEvent</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">detail</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">isPress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">emit</span> <span class="n">buttonRelease</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootX</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">keyButtonPointer</span><span class="p">.</span><span class="n">rootY</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">KeyPress</span><span class="p">:</span>
            <span class="c1">// å‘é€ keyPress ä¿¡å·ï¼Œé™„å¸¦æŒ‰é”®çš„ code</span>
            <span class="n">emit</span> <span class="n">keyPress</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">KeyRelease</span><span class="p">:</span>
            <span class="c1">// å‘é€ keyRelease ä¿¡å·ï¼Œé™„å¸¦æŒ‰é”®çš„ code</span>
            <span class="n">emit</span> <span class="n">keyRelease</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// èµ„æºé‡Šæ”¾</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">XRecordFreeData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è¿‡æ»¤æ»šè½®äº‹ä»¶</span>
<span class="kt">bool</span> <span class="n">EventMonitor</span><span class="o">::</span><span class="n">filterWheelEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">detail</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">detail</span> <span class="o">!=</span> <span class="n">WheelUp</span> <span class="o">&amp;&amp;</span> <span class="n">detail</span> <span class="o">!=</span> <span class="n">WheelDown</span> <span class="o">&amp;&amp;</span> <span class="n">detail</span> <span class="o">!=</span> <span class="n">WheelLeft</span> <span class="o">&amp;&amp;</span> <span class="n">detail</span> <span class="o">!=</span> <span class="n">WheelRight</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ä»£ç ä¸‹è½½">ä»£ç ä¸‹è½½</h3>
<p>å¯ç¼–è¯‘çš„ä»£ç è¯·åœ¨ https://github.com/WHLUG/xrecord-example ä¸‹è½½åï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥æµ‹è¯•ï¼š</p>
<blockquote>
  <p>mkdir build
cd build
qmake ..
make
./xrecord-example</p>
</blockquote>

<p>ç¼–è¯‘å®Œæˆä»¥åï¼Œä¼šå¼¹å‡ºä¸€ä¸ªQtçª—å£ï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹é¼ æ ‡å’Œé”®ç›˜çš„äº‹ä»¶ä¿¡æ¯ï¼Œå¤§å®¶å¯ä»¥åŸºäºä¸Šé¢çš„ä»£ç è¿›è¡Œæ”¹é€ ï¼Œä»¥èåˆåˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚</p>

<p><img src="http://localhost:4000/pics/global-event-monitor/global-event-monitor.png" alt="å…¨å±€äº‹ä»¶ç›‘å¬" /></p>

<p>æˆ‘å¯¹å¼€å‘è€…çš„å­¦ä¹ ä¸€é¡¹æ–°æŠ€æœ¯çš„å»ºè®®æ˜¯ï¼š</p>
<blockquote>
  <p>å…ˆæ‹·è´ç°æœ‰ä»£ç â†’ç²¾ç®€æç‚¼å‡ºæ ¸å¿ƒä»£ç â†’èåˆåˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œå…ˆä¼šç”¨â†’ç”¨çš„ç†Ÿç»ƒä»¥åå†ç ”ç©¶APIå’Œæ¯ä¸€ä¸ªå‚æ•°ç»†èŠ‚â†’æœ€åæŸ¥çœ‹åº•å±‚åº“æºä»£ç </p>
</blockquote>

<p>åªæœ‰å…ˆå®è·µæ‰èƒ½çœŸæ­£ç†è§£å¼€æºé¡¹ç›®çš„åŸä½œè€…ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Œæœ€åæ‰èƒ½çœŸæ­£å¸æ”¶è¿™äº›æŠ€æœ¯ï¼Œåšå¥½å¼€æºè´¡çŒ®ã€‚</p>
:ET